using CRM007.CRM.SDK.Core;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Client;
using Microsoft.Crm.Sdk.Messages;
using System;
using System.Collections.Generic;
using VRM.Integration.Servicebus.Core;
using VRM.Integration.UDO.Ratings.Messages;
using VRM.Integration.Servicebus.Logging.CRM.Util;
 using Logger = VRM.Integration.Servicebus.Core.Logger;
	/// <summary>
	/// VIMT LOB Component for UDOUDOcreateDeathRating,UDOcreateDeathRating method, Processor.
	/// Code Generated by IMS on: 6/15/2015 11:09:42 AM
	/// Version: 2015.06.02
	/// </summary>
	/// <param name=none></param>
	/// <returns>none</returns>
using VIMT.RatingWebService.Messages;
using VRM.Integration.Common;
namespace VRM.Integration.UDO.Ratings.Processors
{
	class UDOUDOcreateDeathRatingProcessor 
	{
		public IMessageBase Execute(UDOcreateDeathRatingRequest request)
		{
			//var request = message as UDOcreateDeathRatingRequest;
			UDOcreateDeathRatingResponse response = new UDOcreateDeathRatingResponse();
			var progressString = "Top of Processor";

			if (request == null)
			{
				response.ExceptionMessage = "Called with no message";
				response.ExceptionOccured = true;
				return response;
			}

			Logger.Instance.Info(string.Format("Message Id:{0}, Type={2}, Recieved diagnostics message: {1}",
			request.MessageId,
			request.MessageId,
			GetType().FullName));

			OrganizationServiceProxy OrgServiceProxy;

			#region connect to CRM
			try
			{
				var CommonFunctions = new CRMCommonFunctions();

				OrgServiceProxy = CommonFunctions.ConnectToCrm(request.OrganizationName);

			}
			catch (Exception connectException)
			 {
				LogHelper.LogError(request.OrganizationName, "mcs_UDOcreateDeathRating", request.UserId, "UDOUDOcreateDeathRatingProcessor Processor, Progess:" + progressString, connectException);
				response.ExceptionMessage = "Failed to get CRMConnection";
				response.ExceptionOccured = true;
				return response;
			}
			#endregion

			progressString = "After Connection";

			try
			{
				// prefix = fnrtngdtfindRatingDataRequest();
				var findRatingDataRequest = new  VIMTfnrtngdtfindRatingDataRequest();
				findRatingDataRequest.LogTiming = request.LogTiming;
				findRatingDataRequest.LogSoap = request.LogSoap;
				findRatingDataRequest.Debug = request.Debug;
				findRatingDataRequest.RelatedParentEntityName = request.RelatedParentEntityName;
				findRatingDataRequest.RelatedParentFieldName = request.RelatedParentFieldName;
				findRatingDataRequest.RelatedParentId = request.RelatedParentId;
				findRatingDataRequest.UserId = request.UserId;
				findRatingDataRequest.OrganizationName = request.OrganizationName;
				
				findRatingDataRequest.mcs_filenumber = request.fileNumber;
				
				var findRatingDataResponse = findRatingDataRequest.SendReceive<VIMTfnrtngdtfindRatingDataResponse>(MessageProcessType.Local);
				progressString = "After VIMT EC Call";
				
				response.ExceptionMessage =findRatingDataResponse.ExceptionMessage;
				response.ExceptionOccured = findRatingDataResponse.ExceptionOccured;
				if (findRatingDataResponse.!=null) {
						var responseIds = new UDOUDOcreateDeathRatingMultipleResponse();
						//instantiate the new Entity
						Entity thisNewEntity = new Entity();
						thisNewEntity.LogicalName = "";
					if (findRatingDataResponse..mcs_militaryServicePeriodTypeName!=string.Empty)
					{
						thisNewEntity["udo_militaryserviceperiod"]= findRatingDataResponse..mcs_militaryServicePeriodTypeName;
					}
					if (findRatingDataResponse..mcs_personDeathCauseTypeName!=string.Empty)
					{
						thisNewEntity["udo_persondeathcause"]= findRatingDataResponse..mcs_personDeathCauseTypeName;
					}
					if (findRatingDataResponse..mcs_ratingDate!=string.Empty)
					{
						thisNewEntity["udo_ratingdate"]= findRatingDataResponse..mcs_ratingDate;
					}
					if (findRatingDataResponse..mcs_ratingDecisionID!=string.Empty)
					{
						thisNewEntity["udo_ratingdecisionid"]= findRatingDataResponse..mcs_ratingDecisionID;
					}
					if (findRatingDataResponse..mcs_serviceConnectedDeathDecisionTypeName!=string.Empty)
					{
						thisNewEntity["udo_serviceconnecteddeathdecision"]= findRatingDataResponse..mcs_serviceConnectedDeathDecisionTypeName;
					}
					if (request.UDOUDOcreateDeathRatingRelatedEntitiesInfo!=null){
						foreach (var relatedItem in request.UDOUDOcreateDeathRatingRelatedEntitiesInfo)
						{
						    thisNewEntity[relatedItem.RelatedEntityFieldName] = new EntityReference(relatedItem.RelatedEntityName, relatedItem.RelatedEntityId);
						}
					}
					responseIds.newUDOUDOcreateDeathRatingId = OrgServiceProxy.Create(thisNewEntity);
					UDOcreateDeathRatingArray.Add(responseIds);
				}
				response.UDOUDOcreateDeathRatingInfo = UDOcreateDeathRatingArray.ToArray();
				
			//added to generated code
			if (request.udo_ratingId != System.Guid.Empty)
			{
				var parent = new Entity();
				parent.Id = request.udo_ratingId;
				parent.LogicalName = "udo_rating";
				parent["udo_deathratingcomplete"] = true;
				 parent["udo_deathratingmessage"] = "";
				OrgServiceProxy.Update(parent);
			}
				return response;
        }
			catch (Exception connectException)
			 {
				LogHelper.LogError(request.OrganizationName, "udo_deathrating", request.UserId, "UDOUDOcreateDeathRatingProcessor Processor, Progess:" + progressString, connectException);
				response.ExceptionMessage = "Failed to Map EC data to LOB";
				response.ExceptionOccured = true;
			if (request.udo_ratingId != System.Guid.Empty)
			{
				var parent = new Entity();
				parent.Id = request.udo_ratingId;
				parent.LogicalName = "udo_rating";
				 parent["udo_deathratingmessage"] = "";
				OrgServiceProxy.Update(parent);
			}
				return response;
			}
		}
	}
}