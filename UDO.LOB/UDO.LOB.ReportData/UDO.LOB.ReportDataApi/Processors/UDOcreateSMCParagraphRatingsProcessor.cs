using CRM007.CRM.SDK.Core;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Client;
using Microsoft.Crm.Sdk.Messages;
using System;
using System.Collections.Generic;
using VRM.Integration.Servicebus.Core;
using VRM.Integration.UDO.Ratings.Messages;
using VRM.Integration.Servicebus.Logging.CRM.Util;
 using Logger = VRM.Integration.Servicebus.Core.Logger;
	/// <summary>
	/// VIMT LOB Component for UDOUDOcreateSMCParagraphRatings,UDOcreateSMCParagraphRatings method, Processor.
	/// Code Generated by IMS on: 6/12/2015 3:32:20 PM
	/// Version: 2015.06.02
	/// </summary>
	/// <param name=none></param>
	/// <returns>none</returns>
using VIMT.RatingWebService.Messages;
using VRM.Integration.Common;
namespace VRM.Integration.UDO.Ratings.Processors
{
	class UDOcreateSMCParagraphRatingsProcessor 
	{
		public IMessageBase Execute(UDOcreateSMCParagraphRatingsRequest request)
		{
			//var request = message as UDOcreateSMCParagraphRatingsRequest;
			UDOcreateSMCParagraphRatingsResponse response = new UDOcreateSMCParagraphRatingsResponse();
			var progressString = "Top of Processor";

			if (request == null)
			{
				response.ExceptionMessage = "Called with no message";
				response.ExceptionOccured = true;
				return response;
			}

			Logger.Instance.Info(string.Format("Message Id:{0}, Type={2}, Recieved diagnostics message: {1}",
			request.MessageId,
			request.MessageId,
			GetType().FullName));

			OrganizationServiceProxy OrgServiceProxy;

			#region connect to CRM
			try
			{
				var CommonFunctions = new CRMCommonFunctions();

				OrgServiceProxy = CommonFunctions.ConnectToCrm(request.OrganizationName);

			}
			catch (Exception connectException)
			 {
				LogHelper.LogError(request.OrganizationName, "mcs_UDOcreateSMCParagraphRatings", request.UserId, "UDOUDOcreateSMCParagraphRatingsProcessor Processor, Progess:" + progressString, connectException);
				response.ExceptionMessage = "Failed to get CRMConnection";
				response.ExceptionOccured = true;
				return response;
			}
			#endregion

			progressString = "After Connection";

			try
			{
				// prefix = fnrtngdtfindRatingDataRequest();
				var findRatingDataRequest = new  VIMTfnrtngdtfindRatingDataRequest();
				findRatingDataRequest.LogTiming = request.LogTiming;
				findRatingDataRequest.LogSoap = request.LogSoap;
				findRatingDataRequest.Debug = request.Debug;
				findRatingDataRequest.RelatedParentEntityName = request.RelatedParentEntityName;
				findRatingDataRequest.RelatedParentFieldName = request.RelatedParentFieldName;
				findRatingDataRequest.RelatedParentId = request.RelatedParentId;
				findRatingDataRequest.UserId = request.UserId;
				findRatingDataRequest.OrganizationName = request.OrganizationName;
				
				findRatingDataRequest.mcs_filenumber = request.fileNumber;
				
				var findRatingDataResponse = findRatingDataRequest.SendReceive<VIMTfnrtngdtfindRatingDataResponse>(MessageProcessType.Local);
				progressString = "After VIMT EC Call";
				
				response.ExceptionMessage =findRatingDataResponse.ExceptionMessage;
				response.ExceptionOccured = findRatingDataResponse.ExceptionOccured;
				if (findRatingDataResponse.!=null) {
						var responseIds = new UDOUDOcreateSMCParagraphRatingsMultipleResponse();
						//instantiate the new Entity
						Entity thisNewEntity = new Entity();
						thisNewEntity.LogicalName = "";
					if (findRatingDataResponse..mcs_ratingID!=string.Empty)
					{
						thisNewEntity["udo_ratingidentifier"]= findRatingDataResponse..mcs_ratingID;
					}
					if (findRatingDataResponse..mcs_profileDate!=string.Empty)
					{
						thisNewEntity["udo_profiledate"]= findRatingDataResponse..mcs_profileDate;
					}
					if (findRatingDataResponse..mcs_smcParagraphKeyTypeName!=string.Empty)
					{
						thisNewEntity["udo_paragraphkey"]= findRatingDataResponse..mcs_smcParagraphKeyTypeName;
					}
					if (request.UDOUDOcreateSMCParagraphRatingsRelatedEntitiesInfo!=null){
						foreach (var relatedItem in request.UDOUDOcreateSMCParagraphRatingsRelatedEntitiesInfo)
						{
						    thisNewEntity[relatedItem.RelatedEntityFieldName] = new EntityReference(relatedItem.RelatedEntityName, relatedItem.RelatedEntityId);
						}
					}
					responseIds.newUDOUDOcreateSMCParagraphRatingsId = OrgServiceProxy.Create(thisNewEntity);
					UDOUDOcreateSMCParagraphRatingsArray.Add(responseIds);
				}
				response.UDOUDOcreateSMCParagraphRatingsInfo =UDOUDOcreateSMCParagraphRatingsArray.ToArray();
				
			//added to generated code
			if (request.udo_ratingId != System.Guid.Empty)
			{
				var parent = new Entity();
				parent.Id = request.udo_ratingId;
				parent.LogicalName = "udo_rating";
				parent["udo_smcparagraphratingcomplete"] = true;
				 parent["udo_smcparagraphratingmessage"] = "";
				OrgServiceProxy.Update(parent);
			}
				return response;
			}
			catch (Exception connectException)
			 {
				LogHelper.LogError(request.OrganizationName, "udo_smcparagraphrating", request.UserId, "UDOUDOcreateSMCParagraphRatingsProcessor Processor, Progess:" + progressString, connectException);
				response.ExceptionMessage = "Failed to Map EC data to LOB";
				response.ExceptionOccured = true;
			if (request.udo_ratingId != System.Guid.Empty)
			{
				var parent = new Entity();
				parent.Id = request.udo_ratingId;
				parent.LogicalName = "udo_rating";
				 parent["udo_smcparagraphratingmessage"] = "";
				OrgServiceProxy.Update(parent);
			}
				return response;
			}
		}
	}
}
