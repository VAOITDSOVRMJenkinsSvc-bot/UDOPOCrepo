using CRM007.CRM.SDK.Core;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Client;
using Microsoft.Crm.Sdk.Messages;
using System;
using System.Collections.Generic;
using VRM.Integration.Servicebus.Core;
using VRM.Integration.UDO.Ratings.Messages;
using VRM.Integration.Servicebus.Logging.CRM.Util;
 using Logger = VRM.Integration.Servicebus.Core.Logger;
	/// <summary>
	/// VIMT LOB Component for UDOUDOcreateDisabilityRatings,UDOcreateDisabilityRatings method, Processor.
	/// Code Generated by IMS on: 6/11/2015 1:20:32 PM
	/// Version: 2015.06.02
	/// </summary>
	/// <param name=none></param>
	/// <returns>none</returns>
using VIMT.RatingWebService.Messages;
using VRM.Integration.Common;
namespace VRM.Integration.UDO.Ratings.Processors
{
	class UDOcreateDisabilityRatingsProcessor 
	{
		public IMessageBase Execute(UDOcreateDisabilityRatingsRequest request)
		{
			//var request = message as UDOcreateDisabilityRatingsRequest;
			UDOcreateDisabilityRatingsResponse response = new UDOcreateDisabilityRatingsResponse();
			var progressString = "Top of Processor";

			if (request == null)
			{
				response.ExceptionMessage = "Called with no message";
				response.ExceptionOccured = true;
				return response;
			}

			Logger.Instance.Info(string.Format("Message Id:{0}, Type={2}, Recieved diagnostics message: {1}",
			request.MessageId,
			request.MessageId,
			GetType().FullName));

			OrganizationServiceProxy OrgServiceProxy;

			#region connect to CRM
			try
			{
				var CommonFunctions = new CRMCommonFunctions();

				OrgServiceProxy = CommonFunctions.ConnectToCrm(request.OrganizationName);

			}
			catch (Exception connectException)
			 {
				LogHelper.LogError(request.OrganizationName, "mcs_UDOcreateDisabilityRatings", request.UserId, "UDOUDOcreateDisabilityRatingsProcessor Processor, Progess:" + progressString, connectException);
				response.ExceptionMessage = "Failed to get CRMConnection";
				response.ExceptionOccured = true;
				return response;
			}
			#endregion

			progressString = "After Connection";

			try
			{
				// prefix = fnrtngdtfindRatingDataRequest();
				var findRatingDataRequest = new  VIMTfnrtngdtfindRatingDataRequest();
				findRatingDataRequest.LogTiming = request.LogTiming;
				findRatingDataRequest.LogSoap = request.LogSoap;
				findRatingDataRequest.Debug = request.Debug;
				findRatingDataRequest.RelatedParentEntityName = request.RelatedParentEntityName;
				findRatingDataRequest.RelatedParentFieldName = request.RelatedParentFieldName;
				findRatingDataRequest.RelatedParentId = request.RelatedParentId;
				findRatingDataRequest.UserId = request.UserId;
				findRatingDataRequest.OrganizationName = request.OrganizationName;
				
				findRatingDataRequest.mcs_filenumber = request.fileNumber;
				
				var findRatingDataResponse = findRatingDataRequest.SendReceive<VIMTfnrtngdtfindRatingDataResponse>(MessageProcessType.Local);
				progressString = "After VIMT EC Call";
				
				response.ExceptionMessage =findRatingDataResponse.ExceptionMessage;
				response.ExceptionOccured = findRatingDataResponse.ExceptionOccured;
				if (findRatingDataResponse.!=null) {
						var responseIds = new UDOUDOcreateDisabilityRatingsMultipleResponse();
						//instantiate the new Entity
						Entity thisNewEntity = new Entity();
						thisNewEntity.LogicalName = "";
					if (findRatingDataResponse..mcs_beginDate!=string.Empty)
					{
						thisNewEntity["udo_begindate"]= findRatingDataResponse.VIMTfnrtngdtInfo.VIMTfnrtngdtdisabilityRatingRecordInfo.mcs_beginDate;
					}
					if (findRatingDataResponse..mcs_disabilityDecisionTypeCode!=string.Empty)
					{
						thisNewEntity["udo_code"]= findRatingDataResponse..mcs_disabilityDecisionTypeCode;
					}
					if (findRatingDataResponse..mcs_combatIndicator!=string.Empty)
					{
						thisNewEntity["udo_combatind"]= findRatingDataResponse..mcs_combatIndicator;
					}
					if (findRatingDataResponse..mcs_disabilityDecisionTypeName!=string.Empty)
					{
						thisNewEntity["udo_description"]= findRatingDataResponse..mcs_disabilityDecisionTypeName;
					}
					if (findRatingDataResponse..mcs_diagnosticText!=string.Empty)
					{
						thisNewEntity["udo_diagnostic"]= findRatingDataResponse..mcs_diagnosticText;
					}
					if (findRatingDataResponse..mcs_diagnosticPercent!=string.Empty)
					{
						thisNewEntity["udo_diagnosticpercent"]= findRatingDataResponse..mcs_diagnosticPercent;
					}
					if (findRatingDataResponse..mcs_diagnosticTypeName!=string.Empty)
					{
						thisNewEntity["udo_diagnostictype"]= findRatingDataResponse..mcs_diagnosticTypeName;
					}
					if (findRatingDataResponse..mcs_diagnosticTypeCode!=string.Empty)
					{
						thisNewEntity["udo_diagnostictypecode"]= findRatingDataResponse..mcs_diagnosticTypeCode;
					}
					if (findRatingDataResponse..mcs_disabilityID!=string.Empty)
					{
						thisNewEntity["udo_disabilityid"]= findRatingDataResponse..mcs_disabilityID;
					}
					if (request.UDOUDOcreateDisabilityRatingsRelatedEntitiesInfo!=null){
						foreach (var relatedItem in request.UDOUDOcreateDisabilityRatingsRelatedEntitiesInfo)
						{
						    thisNewEntity[relatedItem.RelatedEntityFieldName] = new EntityReference(relatedItem.RelatedEntityName, relatedItem.RelatedEntityId);
						}
					}
					responseIds.newUDOUDOcreateDisabilityRatingsId = OrgServiceProxy.Create(thisNewEntity);
					UDOUDOcreateDisabilityRatingsArray.Add(responseIds);
				}
				response.UDOUDOcreateDisabilityRatingsInfo =UDOUDOcreateDisabilityRatingsArray.ToArray();
				
			//added to generated code
			if (request.udo_ratingId != System.Guid.Empty)
			{
				var parent = new Entity();
				parent.Id = request.udo_ratingId;
				parent.LogicalName = "udo_rating";
				parent["udo_disabilityratingcomplete"] = true;
				 parent["udo_disabilityratingmessage"] = "";
				OrgServiceProxy.Update(parent);
			}
				return response;
			}
			catch (Exception connectException)
			 {
				LogHelper.LogError(request.OrganizationName, "udo_disabilityrating", request.UserId, "UDOUDOcreateDisabilityRatingsProcessor Processor, Progess:" + progressString, connectException);
				response.ExceptionMessage = "Failed to Map EC data to LOB";
				response.ExceptionOccured = true;
			if (request.udo_ratingId != System.Guid.Empty)
			{
				var parent = new Entity();
				parent.Id = request.udo_ratingId;
				parent.LogicalName = "udo_rating";
				 parent["udo_disabilityratingmessage"] = "";
				OrgServiceProxy.Update(parent);
			}
				return response;
			}
		}
	}
}
