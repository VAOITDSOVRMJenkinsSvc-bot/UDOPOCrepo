using Microsoft.Xrm.Sdk.Client;
using Microsoft.Xrm.Sdk.Query;
using System;
using VIMT.DevelopmentNotesService.Messages;
using VRM.Integration.Servicebus.Core;
using VRM.Integration.Servicebus.Logging.CRM.Util;
using VRM.Integration.UDO.Common;
using VRM.Integration.UDO.Notes.Messages;
using HeaderInfo = VIMT.DevelopmentNotesService.Messages.HeaderInfo;

/// <summary>
/// VIMT LOB Component for UDOCreateNote,CreateNote method, Processor.
/// Code Generated by IMS on: 6/27/2015 2:48:16 PM
/// Version: 2015.06.02
/// </summary>
/// <param name=none></param>
/// <returns>none</returns>
namespace VRM.Integration.UDO.Notes.Processors
{
    public class UDOUpdateNoteProcessor
    {
        private bool _debug { get; set; }
        private const string method = "UDOUpdateNoteRequest";
        private string LogBuffer { get; set; }
        
        public IMessageBase Execute(UDOUpdateNoteRequest request)
        {
            if (String.IsNullOrEmpty(request.udo_User)) {
            
            }

            //var request = message as CreateNoteRequest;
            var response = new UDOUpdateNoteResponse();
            var progressString = "Top of Processor";
            LogBuffer = string.Empty;
            _debug = request.Debug;

            if (request == null)
            {
                response.ExceptionMessage = "Called with no message";
                response.ExceptionOccured = true;
                return response;
            }

            try
            {
                #region Validate User Created Note.
                if (!String.IsNullOrEmpty(request.udo_User))
                {
                    #region connect to CRM

                    OrganizationServiceProxy OrgServiceProxy;
                    try
                    {
                        var CommonFunctions = new CRMConnect();

                        OrgServiceProxy = CommonFunctions.ConnectToCrm(request.OrganizationName);
                    }
                    catch (Exception connectException)
                    {
                        LogHelper.LogError(request.OrganizationName, request.UserId, string.Format("{0} Processor, Connection Error", method), connectException.Message);
                        response.ExceptionMessage = "Failed to get CRMConnection";
                        response.ExceptionOccured = true;
                        return response;
                    }

                    #endregion
                    OrgServiceProxy.CallerId = request.UserId;
                    var crmUser = OrgServiceProxy.Retrieve("systemuser", request.UserId, new ColumnSet("va_pcrssn"));
                    if (crmUser.Contains("va_pcrssn"))
                    {
                        var pcrssn = crmUser["va_pcrssn"].ToString();
                        if (!String.IsNullOrEmpty(pcrssn) && 
                            !String.Equals(pcrssn, request.udo_User, StringComparison.InvariantCultureIgnoreCase))
                        {
                            throw new Exception("customOnly the original User can update a note.");
                        }
                    }
                }
                #endregion

                // prefix = createcreateNoteRequest();
                var updateNoteRequest = new VIMTupdateupdateNoteRequest
                {
                    LogTiming = request.LogTiming,
                    LogSoap = request.LogSoap,
                    Debug = request.Debug,
                    RelatedParentEntityName = request.RelatedParentEntityName,
                    RelatedParentFieldName = request.RelatedParentFieldName,
                    RelatedParentId = request.RelatedParentId,
                    UserId = request.UserId,
                    OrganizationName = request.OrganizationName
                };
                var nowNow = DateTime.Now;

                var nowTime = string.Format("00", (nowNow.Day)) + "-" + string.Format("00", (nowNow.Month + 1)) + "-" +
                              string.Format("00", (nowNow.Day + 1)) + nowNow.ToUniversalTime();

                // var createnowTime = nowNow + "-" + string.Format("00", (nowNow.Month + 1)) + "-" + string.Format("00", (nowNow.Day + 1)) + nowNow.ToUniversalTime().ToString();

                var tempString = DateTime.Now.ToString("yyyy-MM-ddTHH:MM:ss-4:00");

                var tempDate = DateTime.Parse(tempString);
                DateTime dtTime;

                updateNoteRequest.noteInfo = new VIMTupdatenote
                {
                    //mcs_jrnLctnId = request.udo_RO,
                    mcs_suspnsDt = tempDate,
                    mcs_suspnsDtSpecified = true,
                    mcs_txt = request.udo_Note,
                    mcs_userId = request.udo_User,
                    mcs_ptcpntId = request.udo_ParticipantID,
                    mcs_jrnDt = tempDate,
                    mcs_jrnDtSpecified = true,
                    mcs_modifdDt = tempDate,
                    mcs_modifdDtSpecified = true
                    //,mcs_jrnUserId = request.udo_User
                };

                if (!string.IsNullOrEmpty(request.udo_dtTime))
                {
                    dtTime = DateTime.Parse(request.udo_dtTime);
                    updateNoteRequest.noteInfo.mcs_createDt = dtTime;
                    updateNoteRequest.noteInfo.mcs_noteId = "";
                    updateNoteRequest.noteInfo.mcs_createDtSpecified = true;
                    LogHelper.LogDebug(request.OrganizationName, request.Debug, request.UserId, method,
                        string.Format("The note was created on {0}", request.udo_dtTime));
                }
                else
                {
                    if (request.udo_LegacyNoteId.Length > 0)
                    {
                        updateNoteRequest.noteInfo.mcs_noteId = request.udo_LegacyNoteId;
                        LogHelper.LogDebug(request.OrganizationName, request.Debug, request.UserId,
                           method, string.Format("Note ID: {0}", request.udo_LegacyNoteId));
                    }
                }
                if (request.udo_ClaimId != null)
                {
                    updateNoteRequest.noteInfo.mcs_bnftClmNoteTc = "CLMDVLNOTE";
                    updateNoteRequest.noteInfo.mcs_noteOutTn = "Claim Development Note";
                    updateNoteRequest.noteInfo.mcs_clmId = request.udo_ClaimId;
                }
                else
                {
                    updateNoteRequest.noteInfo.mcs_ptcpntNoteTc = "CLMNTCONTACT";
                    updateNoteRequest.noteInfo.mcs_noteOutTn = "Contact with Claimant";
                }

                updateNoteRequest.LegacyServiceHeaderInfo = new HeaderInfo
                {
                    ApplicationName = request.LegacyServiceHeaderInfo.ApplicationName,
                    ClientMachine = request.LegacyServiceHeaderInfo.ClientMachine,
                    LoginName = request.LegacyServiceHeaderInfo.LoginName,
                    StationNumber = request.LegacyServiceHeaderInfo.StationNumber
                };

                if (!string.IsNullOrEmpty(request.udo_ClaimId))
                {
                    updateNoteRequest.noteInfo.mcs_callId = long.Parse(request.udo_ClaimId);
                }

                LogHelper.LogDebug(request.OrganizationName, request.Debug, request.UserId, method,
                    "Sending data to VIMT");

                //VIMT doesn't return data??
                //updateNoteRequest.Send(MessageProcessType.Local);
                var updateNoteResponse =
                    updateNoteRequest.SendReceive<VIMTupdateupdateNoteResponse>(MessageProcessType.Local);

                progressString = "After VIMT EC Call";
                //response.ExceptionMessage = "Update Submitted";
                //response.ExceptionOccured = false;

                response.ExceptionMessage = updateNoteResponse.ExceptionMessage;
                response.ExceptionOccured = updateNoteResponse.ExceptionOccured;
                //if (updateNoteResponse.VIMTupdateupdatedNoteInfo != null)
                //{
                //}
                return response;
            }
            catch (Exception ExecutionException)
            {
                LogHelper.LogError(request.OrganizationName, request.UserId, request.RelatedParentId, request.RelatedParentEntityName, request.RelatedParentFieldName, method + " Processor, Progess:" + progressString, ExecutionException);
                response.ExceptionMessage = "Failed to Process Notes Data"; 
                response.ExceptionOccured = true;
                return response;
            }
        }
    }
}