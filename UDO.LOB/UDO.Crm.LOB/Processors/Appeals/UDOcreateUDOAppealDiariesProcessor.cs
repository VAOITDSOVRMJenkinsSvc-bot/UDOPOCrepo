// using CRM007.CRM.SDK.Core;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Client;
using Microsoft.Crm.Sdk.Messages;
using System;
using System.Collections.Generic;
using VRM.Integration.Servicebus.Core;
using VRM.Integration.UDO.Appeals.Messages;
using VRM.Integration.Servicebus.Logging.CRM.Util;
using Logger = VRM.Integration.Servicebus.Core.Logger;
/// <summary>
/// VIMT LOB Component for UDOcreateUDOAppealDiaries,createUDOAppealDiaries method, Processor.
/// Code Generated by IMS on: 7/10/2015 11:20:40 AM
/// Version: 2015.06.02
/// </summary>
/// <param name=none></param>
/// <returns>none</returns>
using VIMT.AppealService.Messages;
using VRM.Integration.UDO.Common;


namespace VRM.Integration.UDO.Appeals.Processors
{
    using VIMT.AppealService.Messages;
    class UDOcreateUDOAppealDiariesProcessor
    {
        public IMessageBase Execute(UDOcreateUDOAppealDiariesRequest request)
        {
            //var request = message as createUDOAppealDiariesRequest;
            UDOcreateUDOAppealDiariesResponse response = new UDOcreateUDOAppealDiariesResponse();
            var progressString = "Top of Processor";

            if (request == null)
            {
                response.ExceptionMessage = "Called with no message";
                response.ExceptionOccured = true;
                return response;
            }

            //TODO(NP): Logging to be added Logger.Instance.Info(string.Format("Message Id:{0}, Type={2}, Recieved diagnostics message: {1}",
            //request.MessageId,
            //request.MessageId,
            //GetType().FullName));

            OrganizationServiceProxy OrgServiceProxy;

            #region connect to CRM
            try
            {
                var CommonFunctions = new CRMConnect();
                // TODO(NP): Review this line of code  var CommonFunctions = new CRMCommonFunctions();

                OrgServiceProxy = CommonFunctions.ConnectToCrm(request.OrganizationName);

            }
            catch (Exception connectException)
            {
                LogHelper.LogError(request.OrganizationName, "mcs_createUDOAppealDiaries", request.UserId, "UDOcreateUDOAppealDiariesProcessor Processor, Progess:" + progressString, connectException);
                response.ExceptionMessage = "Failed to get CRMConnection";
                response.ExceptionOccured = true;
                return response;
            }
            #endregion

            progressString = "After Connection";

            try
            {
                // prefix = gtaplgetAppealRequest();
                var getAppealRequest = new VIMTgtaplgetAppealRequest();
                getAppealRequest.LogTiming = request.LogTiming;
                getAppealRequest.LogSoap = request.LogSoap;
                getAppealRequest.Debug = request.Debug;
                getAppealRequest.RelatedParentEntityName = request.RelatedParentEntityName;
                getAppealRequest.RelatedParentFieldName = request.RelatedParentFieldName;
                getAppealRequest.RelatedParentId = request.RelatedParentId;
                getAppealRequest.UserId = request.UserId;
                getAppealRequest.OrganizationName = request.OrganizationName;

                //TODO(NP): Update the VIMT call to VEIS
                var getAppealResponse = getAppealRequest.SendReceive<VIMTgtaplgetAppealResponse>(MessageProcessType.Local);
                progressString = "After VIMT EC Call";

                response.ExceptionMessage = getAppealResponse.ExceptionMessage;
                response.ExceptionOccured = getAppealResponse.ExceptionOccured;
                if (getAppealResponse.VIMTgtaplGetAppealResponseInfo.VIMTgtaplAppealRecordInfo.VIMTgtaplDiaryInfo != null)
                {
                    var Diary = getAppealResponse.VIMTgtaplGetAppealResponseInfo.VIMTgtaplAppealRecordInfo.VIMTgtaplDiaryInfo;
                    System.Collections.Generic.List<UDOcreateUDOAppealDiariesMultipleResponse> UDOcreateUDOAppealDiariesArray = new System.Collections.Generic.List<UDOcreateUDOAppealDiariesMultipleResponse>();
                    foreach (var DiaryItem in Diary)
                    {
                        var responseIds = new UDOcreateUDOAppealDiariesMultipleResponse();
                        //instantiate the new Entity
                        Entity thisNewEntity = new Entity();
                        thisNewEntity.LogicalName = "udo_appealdiaries";
                        if (!string.IsNullOrEmpty(DiaryItem.mcs_ResponseNotesDescription))
                        {
                            thisNewEntity["udo_responsenotesdescription"] = DiaryItem.mcs_ResponseNotesDescription;
                        }
                        if (!string.IsNullOrEmpty(DiaryItem.mcs_RequestedActivityDescription))
                        {
                            thisNewEntity["udo_reqactivitydescription"] = DiaryItem.mcs_RequestedActivityDescription;
                        }
                        if (DiaryItem.mcs_DiarySuspenseDueDate != System.DateTime.MinValue)
                        {
                            thisNewEntity["udo_duedate"] = DiaryItem.mcs_DiarySuspenseDueDate;
                        }
                        if (!string.IsNullOrEmpty(DiaryItem.mcs_DiaryDescription))
                        {
                            thisNewEntity["udo_diarydescription"] = DiaryItem.mcs_DiaryDescription;
                        }
                        thisNewEntity["udo_daystocomplete"] = DiaryItem.mcs_DaysToCompleteDiaryItemQuantity;
                        if (!string.IsNullOrEmpty(DiaryItem.mcs_BVAorRODiaryIndicatorText))
                        {
                            thisNewEntity["udo_bvaro"] = DiaryItem.mcs_BVAorRODiaryIndicatorText;
                        }
                        if (!string.IsNullOrEmpty(DiaryItem.mcs_AssignedStaffMemberName))
                        {
                            thisNewEntity["udo_assignedto"] = DiaryItem.mcs_AssignedStaffMemberName;
                        }
                        if (DiaryItem.mcs_AssignedToStaffMemberDate != System.DateTime.MinValue)
                        {
                            thisNewEntity["udo_assigneddate"] = DiaryItem.mcs_AssignedToStaffMemberDate;
                        }
                        if (!string.IsNullOrEmpty(DiaryItem.mcs_DiaryStatusDescription))
                        {
                            thisNewEntity["udo_status"] = DiaryItem.mcs_DiaryStatusDescription;
                        }
                        if (DiaryItem.mcs_DiaryClosedDate != System.DateTime.MinValue)
                        {
                            thisNewEntity["udo_closeddate"] = DiaryItem.mcs_DiaryClosedDate;
                        }
                        if (request.UDOcreateUDOAppealDiariesRelatedEntitiesInfo != null)
                        {
                            foreach (var relatedItem in request.UDOcreateUDOAppealDiariesRelatedEntitiesInfo)
                            {
                                thisNewEntity[relatedItem.RelatedEntityFieldName] = new EntityReference(relatedItem.RelatedEntityName, relatedItem.RelatedEntityId);
                            }
                        }
                        responseIds.newUDOcreateUDOAppealDiariesId = OrgServiceProxy.Create(thisNewEntity);
                        UDOcreateUDOAppealDiariesArray.Add(responseIds);
                    }
                    response.UDOcreateUDOAppealDiariesInfo = UDOcreateUDOAppealDiariesArray.ToArray();
                }
                //added to generated code
                if (request.udo_appealId != System.Guid.Empty)
                {
                    var parent = new Entity();
                    parent.Id = request.udo_appealId;
                    parent.LogicalName = "udo_appeal";
                    parent["udo_appealdiariescomplete"] = true;
                    parent["udo_appealdiariesmessage"] = "";
                    OrgServiceProxy.Update(parent);
                }
                return response;
            }
            catch (Exception connectException)
            {
                LogHelper.LogError(request.OrganizationName, "udo_appealdiaries", request.UserId, "UDOcreateUDOAppealDiariesProcessor Processor, Progess:" + progressString, connectException);
                response.ExceptionMessage = "Failed to Map EC data to LOB";
                response.ExceptionOccured = true;
                if (request.udo_appealId != System.Guid.Empty)
                {
                    var parent = new Entity();
                    parent.Id = request.udo_appealId;
                    parent.LogicalName = "udo_appeal";
                    parent["udo_appealdiariesmessage"] = "";
                    OrgServiceProxy.Update(parent);
                }
                return response;
            }
        }
    }
}