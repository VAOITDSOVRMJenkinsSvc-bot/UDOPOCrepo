<html>
<head>
    <title>Person Search</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" charset="utf-8">
    <meta>
</head>
<body style="overflow-wrap: break-word;">
    <style type="text/css">
        fieldset {
            color: rgb(0,0,0);
            direction: ltr;
            font-family: "Segoe UI","Segoe UI Web Regular","Segoe UI Symbol","Helvetica Neue","BBAlpha Sans","S60 Sans",Arial,sans-serif;
            font-size: 16px;
            /*line-height: 20px;*/
            /*font-weight: 100;*/
            margin-bottom: 14px;
            margin-left: 0;
            margin-right: 0;
            margin-top: 0;
            background-color: rgb(255,255,255);
            padding: 2px;
            border: solid 0 #ffffff;
            width: 100%;
        }
            /*fieldset legend {
            position:absolute;
            left:-10000px;
            top:auto;
            width:1px;
            height:1px;
            overflow: hidden;
        }*/
            fieldset legend {
                display: none;
            }

        table {
            border-collapse: collapse;
            font-family: "Segoe UI","Segoe UI Web Regular","Segoe UI Symbol","Helvetica Neue","BBAlpha Sans","S60 Sans",Arial,sans-serif;
            width: 705px;
        }

        th {
            background-color: #ffffff;
            color: black;
            font-family: "Segoe UI Light","Segoe UI Web Regular","Segoe UI Symbol","Helvetica Neue","BBAlpha Sans","S60 Sans",Arial,sans-serif;
            font-size: 16px;
            /*line-height: 20px;*/
            font-weight: 600;
            white-space: nowrap;
            text-align: left;
            padding: 5px;
        }

        td {
            padding: 5px;
            white-space: nowrap;
        }

        tr:focus {
            background-color: aliceblue;
            color: #800000;
        }

        .odd {
            background-color: white;
            cursor: pointer;
        }

        .even {
            background-color: whitesmoke;
            cursor: pointer;
        }

        .odd:hover {
            background-color: #99ccff;
            color: #600000;
        }

        .even:hover {
            background-color: #99ccff;
            color: #600000;
        }

        div#tmpDialog {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 250px;
            height: 50px;
            margin: -101px 0 0 -251px;
            background: rgb(255, 255, 255);
            border: 1px solid black;
        }

            div#tmpDialog img {
                float: left;
                height: 45px;
                width: 45px;
                padding: 5px 10px 5px 5px;
                text-align: left;
            }

            div#tmpDialog p {
                padding: 5px;
                margin: 15px 5px 5px 5px;
                text-align: left;
            }

        input.formInputText {
            background-color: rgba(255,255,255,0);
            border-color: rgb(186,186,186);
            border-width: 1px;
            border-style: solid;
            color: rgb(0,0,0);
            font-family: "Segoe UI","Segoe UI Web Regular","Segoe UI Symbol","Helvetica Neue","BBAlpha Sans","S60 Sans",Arial,sans-serif;
            font-size: 14.06px;
            height: 30px;
            /*line-height: normal;*/
        }

        div.search {
            color: rgb(0,0,0);
            direction: ltr;
            float: left;
            font-family: "Segoe UI","Segoe UI Web Regular","Segoe UI Symbol","Helvetica Neue","BBAlpha Sans","S60 Sans",Arial,sans-serif;
            font-size: 12.06px;
            /*line-height: 17px;*/
            padding-bottom: 4px;
            padding-top: 0;
            text-align: left;
        }

        input.search {
            color: rgb(0,0,0);
            direction: ltr;
            float: left;
            font-family: "Segoe UI","Segoe UI Web Regular","Segoe UI Symbol","Helvetica Neue","BBAlpha Sans","S60 Sans",Arial,sans-serif;
            font-size: 12.06px;
            /*line-height: 17px;*/
            padding-bottom: 4px;
            padding-top: 0;
            text-align: left;
        }

        span.button,
        button {
            background-color: rgb(0,32,80);
            border-color: rgb(255,255,255);
            border-width: 0px;
            color: rgb(255,255,255);
            direction: ltr;
            font-family: "Segoe UI Semibold","Segoe UI Web Semibold","Segoe UI Web Regular","Segoe UI","Segoe UI Symbol","HelveticaNeue-Medium","Helvetica Neue",Arial,sans-serif;
            font-size: 14.06px;
            /*height: 30px;*/
            /*line-height: auto;*/ /*20px;*/
            min-width: 84.4px;
            padding-bottom: 5px;
            padding-left: 12px;
            padding-right: 12px;
            padding-top: 5px;
            margin-right: 6px;
        }

            /*
                span.button:hover,
                button:hover {
                    background-color: rgb(128,0,0);
                }
                */

            button:disabled {
                background-color: gray;
                color: white;
            }

        @media screen and (-ms-high-contrast: active) {
            /*TODO: validate high contrast settings*/
            button {
                border-color: ActiveBorder;
            }
        }

        h1 {
            font-family: 'Segoe UI',Tahoma,Arial;
            font-weight: 100;
            color: #262626;
            font-size: 36px;
            /*line-height: 20px;*/
            margin-bottom: 12px;
        }

        h2 {
            font-family: 'Segoe UI',Tahoma,Arial;
            font-weight: 100;
            color: #262626;
            font-size: 22px;
            /*line-height: 10px;*/
            white-space: nowrap;
            margin-bottom: 12px;
            margin-top: 8px;
        }

        /*h2 {
                    color: rgb(0,0,0);
                    direction: ltr;
                    font-family: "Segoe UI","Segoe UI Web Regular","Segoe UI Symbol","Helvetica Neue","BBAlpha Sans","S60 Sans",Arial,sans-serif;
                    font-size: 14.06px;
                    font-weight: 100;
                    margin-bottom: 14px;
                    margin-left: 0px;
                    margin-right: 0px;
                    margin-top: 0px;
                }*/

        fieldset {
            border: 0;
        }
        /*

        span {
            color: red;
            font-family: "Segoe UI","Segoe UI Web Regular","Segoe UI Symbol","Helvetica Neue","BBAlpha Sans","S60 Sans",Arial,sans-serif;
            font-size: 14.06px;
            font-weight: 100;
            display: none;
        }
        */

        .auto-style1 {
            width: 142px;
        }

        form {
            clear: both;
        }
    </style>

    <script src="udo_Xrm.min.js" type="text/javascript"></script>
    <script src="udo_jquery1.10.2.min.js" type="text/javascript"></script>
    <script src="crme_SDK.REST.js" type="text/javascript"></script>
    <script src="udo_XrmApiClient.js" type="text/javascript"></script>
    <script src="udo_CRMCommonJS.js" type="text/javascript"></script>
    <script src="crme_json2.js" type="text/javascript"></script>
    <script src="udo_utility.js" type="text/jscript"></script>
    <script src="udo_popup.js" type="text/jscript"></script>
    <script type="text/javascript">
        var context = GetGlobalContext();
        console.log(context.client.getClient());
        var version = context.getVersion();
        var webApi = new CrmCommonJS.WebApi(version);
        window["ENTITY_SET_NAMES"] = window["ENTITY_SET_NAMES"] || JSON.stringify({
            "crme_person": "crme_persons",
            "systemuser": "systemusers",
            "udo_idproof": "udo_idproofs",
            "udo_interaction": "udo_interactions"
        });

        WebApiClient.Configure({
            ApiVersion: "9.0",
            ReturnAllPages: true,
            PrettifyErrors: false
        });

        //CRM Ctrl Key Fix for toString Error
        if (typeof window.LOCID_JUMP_TO_RIBBON == "undefined") window.LOCID_JUMP_TO_RIBBON = "[";
        if (typeof window.LOCID_JUMP_TO_RIBBON_CONTROL == "undefined") window.top.LOCID_JUMP_TO_RIBBON_CONTROL = "]";

        var idProofId = null;
        var veteranId = null;
        var interactionId = null;
        var chatSessionLogId = null;
        var selectAnotherVet = false;
        var ani = null;
        var ctissn = null;
        var ctiedipi = null;
        var ctidob = null;
        var sessionid = null;
        function onIdProofCheckboxTextClick(id) {
            var checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            checkbox.onchange();
        }
        // Error Messages
        var ErrorMessage = function () {
            function error(message, title, options) {
                return popup(message, title, Va.Udo.Crm.Scripts.Popup.PopupStyles.Critical, options);
            }
            function popup(message, title, style, options) {
                if (!title) title = "Error";
                if (!options) options = { height: 200, width: 350 };
                return Va.Udo.Crm.Scripts.Popup.MsgBox(message, style, title, options);
            }

            var messages =
            {
                Message: error,
                PeopleSearch: function (message, title, options) { error("There was an error performing the search.\n\nError:" + message, (title ? title : "People Search Error"), options); },
                Access: function (message, title, options) { error("There was an access error.\n\nError:" + message, (title ? title : "Access Error"), options); },
                IDProof: function (message, title, options) { error(message, (title ? title : "ID Proof Error"), options); },
                Interaction: function (message, title, options) { error(message, (title ? title : "Interaction Error"), options); },
                Warning: function (message, title, options) { popup(message, (title ? title : "Warning"), Va.Udo.Crm.Scripts.Popup.PopupStyles.Exclamation, options); },
                ChatSearch: function (message, title, options) { error("There was an error performing the search.\n\nError:" + message, (title ? title : "Chat Search Error"), options); }
            };

            return messages;
        }();

        // Number Cleaner ---------------------------------------------------------------
        function SetupNumberInputCleaner(jqEl, maxlength) {
            function CleanNumberInput(jqEl, maxlength) {
                var val = jqEl.val();
                val = val.replace(/\D/g, '');
                if (val.length > maxlength) val = val.substring(0, maxlength);
                jqEl.val(val);
            }

            jqEl.keypress(function (e) {
                if (!e) var e = window.event;
                if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                    return false;
                }
            });
            jqEl.change(function () {
                CleanNumberInput($(this), maxlength);
            });
            jqEl.keyup(function (e) {
                if (e.which == 86) { // Number only input, so if lowercase V was pressed, then clean it on the keyup.
                    CleanNumberInput($(this), maxlength);
                    //$this = $(this);
                    //setTimeout(function() { CleanNumberInput($this, maxlength); },5);
                }
            });
        }
        // End Number Cleaner ===========================================================

        $(document).ready(function () {
            //do not submit form to server with GET
            $("form").bind("submit", function (e) {
                e = e || window.event;
                if (e.preventDefault) { e.preventDefault(); } else { e.returnValue = false; }
            });
            $(".forminputtext").attr("autocomplete", "off");
            $("#altSearchButton").attr('disabled', true);
            SetupNumberInputCleaner($("#SocialSecurityTextBox"), 9);
            SetupNumberInputCleaner($("#SocialSecurityBirlsTextBox"), 9);
            GetQueryParams();
            //if there is a Chat Session Log Id passed with the query parameters, then will auto launch search process
            GetChatDetailsIfAvailable();

            performSearchUsingCTIParameters();

            $('#SocialSecurityTextBox').focus();

            //hit the search under the fields area - attended search
            $("#altSearchButton").bind("click", function () {
                $("#SocialSecurityBirlsTextBox").val($("#SocialSecurityTextBox").val());
                $("#FirstNameBirlsTextBox").val($("#FirstNameTextBox").val());
                $("#LastNameBirlsTextBox").val($("#LastNameTextBox").val());

                var dobyear = $("#BirthYearTextBox").val();
                var dobmonth = $("#BirthMonthTextBox").val();
                var dobday = $("#BirthDayTextBox").val();
                var dob = dobmonth + "/" + dobday + "/" + dobyear;

                $("#DobBirlsTextBox").val(dob);
                $("#birlsSearchDiv").show();
                $("#idProofCompleteButton").hide();
                $("#idProofVeteranCompleteButton").hide();
                $("#idProofFailedButton").hide();
            });

            $("#SearchByNameButton").bind("click", function () {
                $("#searchResultsMessageInput").val("");

                validateSearchByName().done(function () {

                    formatExecutingSearch();

                    var dobday = $("#BirthDayTextBox").val() == "dd" ? "" : $("#BirthDayTextBox").val();
                    var dobyear = $("#BirthYearTextBox").val() == "yyyy" ? "" : $("#BirthYearTextBox").val();
                    var dobmonth = $("#BirthMonthTextBox").val() == "mm" ? "" : $("#BirthMonthTextBox").val();
                    var dob = dobmonth + "/" + dobday + "/" + dobyear;
                    var ssn = $("#SocialSecurityTextBox").val();
                    ssn = ssn.replace(/\D/g, ""); // rescrub just incase

                    idProofId = null;
                    veteranId = null;
                    var filter = "$filter=";
                    filter += buildQueryFilter("crme_firstname", $("#FirstNameTextBox").val(), false);
                    filter += buildQueryFilter("crme_lastname", $("#LastNameTextBox").val(), true);
                    filter += buildQueryFilter("crme_searchtype", 'CombinedSearchByFilter', true);
                    if (interactionId != null)
                        filter += buildQueryFilter("crme_udointeractionid", interactionId, true);
                    filter += " and crme_isattended eq true";

                    if (dobyear != "") {
                        filter += " and crme_dobstring eq '" + dob + "'";
                    }
                    if ($("#SocialSecurityTextBox").val() != "") {
                        filter += buildQueryFilter("crme_ssn", ssn, true);
                    }
                    //SDK.REST.retrieveMultipleRecords("crme_person", filter, personSearchCallBack, function (error) { ErrorMessage.PeopleSearch(ErrorMessage.message); }, personSearchComplete);

                    webApi.RetrieveMultiple("crme_person", null, filter)
                        .then(
                            function reply(response) {
                                personSearchCallBack(response);
                                personSearchComplete();
                            }
                        );
                })
                    .fail(function () {
                        formatValidationFailed();
                    });
            });

            $("#SearchByIdentifierButton").bind("click", function () {

                if (validateSearchByIdentifier() == true) {

                    formatExecutingSearch();

                    //var filterPrefix = "$select=*&$filter=";

                    if ($("#EdipiTextBox").val() != "") {
                        var filter = "$filter="
                        filter += buildQueryFilter("crme_edipi", $("#EdipiTextBox").val(), false);
                        filter += buildQueryFilter("crme_classcode", 'MIL', true);
                    }
                    if (interactionId != null)
                        filter += buildQueryFilter("crme_udointeractionid", interactionId, true);
                    filter += buildQueryFilter("crme_searchtype", 'CombinedSearchByIdentifier', true);
                    filter += " and crme_isattended eq false";
                    //filter = encodeURIComponent(filter);

                    //SDK.REST.retrieveMultipleRecords("crme_person", filter, personSearchCallBack, function (error) { ErrorMessage.PeopleSearch(ErrorMessage.message); }, personSearchComplete);

                    webApi.RetrieveMultiple("crme_person", null, filter)
                        .done(
                            function reply(response) {
                                console.log(response);
                                personSearchCallBack(response);
                                personSearchComplete();
                            }
                        );

                } else {
                    formatValidationFailed();
                }
            });

            $('#idProofCompleteButton').bind("click", function () {
                var table = $("#personSearchResultsTable");
                var veteranResult = table.find("[fullName]");
                var rowNum = 0;
                openSelectedPerson(veteranResult[rowNum], false);
            });

            $('#idProofVeteranCompleteButton').bind("click", function () {
                var table = $("#personSearchResultsTable");
                var veteranResult = table.find("[fullName]");
                var rowNum = 0;
                if (interactionId === "00000000-0000-0000-0000-000000000000") {
                    ErrorMessage
                        .Interaction("There is no Interaction loaded. Please close this Session and try again.");
                    $('div#tmpDialog').hide();
                    return;
                }

                var interaction = {};
                if (veteranResult[rowNum]) {
                    interaction.udo_firstname = veteranResult[rowNum].getAttribute("firstName") == null ? "" : veteranResult[rowNum].getAttribute("firstName");
                    interaction.udo_lastname = veteranResult[rowNum].getAttribute("lastName") == null ? "" : veteranResult[rowNum].getAttribute("lastName");
                    interaction.udo_phonenumber = veteranResult[rowNum].getAttribute("phoneNumber") == null ? "" : veteranResult[rowNum].getAttribute("phoneNumber");
                    interaction.udo_relationship = 752280000;
                    interaction.udo_ani = ani == null ? "" : ani;
                    interaction.udo_recordsource = veteranResult[rowNum].getAttribute("recordSource") == null ? "" : veteranResult[rowNum].getAttribute("recordSource");

                    var passingparms = {};
                    if (veteranResult[rowNum]) {
                        passingparms
                            .sessionid = sessionid == null
                                ? ""
                                : sessionid;
                        passingparms
                            .udo_IdProofId = veteranResult[rowNum].getAttribute('udoidproofid') == null
                                ? ""
                                : veteranResult[rowNum].getAttribute('udoidproofid');
                        passingparms
                            .udo_veteranid = veteranResult[rowNum].getAttribute('veteranId') == null
                                ? ""
                                : veteranResult[rowNum].getAttribute('veteranId');
                        passingparms
                            .udo_FirstName = veteranResult[rowNum].getAttribute("firstName") == null
                                ? ""
                                : veteranResult[rowNum].getAttribute("firstName");
                        passingparms
                            .udo_LastName = veteranResult[rowNum].getAttribute("lastName") == null
                                ? ""
                                : veteranResult[rowNum].getAttribute("lastName");
                        passingparms
                            .udo_PhoneNumber = veteranResult[rowNum].getAttribute("phoneNumber") == null
                                ? ""
                                : veteranResult[rowNum].getAttribute("phoneNumber");
                        passingparms
                            .udo_FileNumber = veteranResult[rowNum].getAttribute("fileNumber") == null
                                ? ""
                                : veteranResult[rowNum].getAttribute("fileNumber");
                        passingparms.udo_recordsource = veteranResult[rowNum].getAttribute("recordSource") == null ? "" : veteranResult[rowNum].getAttribute("recordSource");
                    }

                    //SDK.REST.updateRecord(interactionId,
                    //     interaction,
                    //     "udo_interaction",
                    webApi.UpdateRecord(interactionId, "udo_interaction", interaction)
                        .then(
                            function reply(response) {
                                console.log(response);
                                //Send interaction to context and refresh if selecting to ID Caller as Veteran
                                if (window.IsUSD == true) {
                                    window.open("http://event/?eventName=IDProofComplete&sessionid=" + sessionid + "&RelationshipToVeteran=953850000&vetId=" + passingparms.udo_veteranid + "&idProofId=" + passingparms.udo_IdProofId + "&firstName=" + passingparms.udo_FirstName + "&lastName=" + passingparms.udo_LastName + "&phoneNumber=" + passingparms.udo_PhoneNumber + "&vetFn=" + passingparms.udo_FileNumber + "&recordsource=" + passingparms.udo_recordsource);
                                }
                            });
                }

                openSelectedPerson(veteranResult[rowNum], true);
            });

            $('#idProofFailedButton').bind("click", function () {
                var table = $("#personSearchResultsTable");
                var veteranResult = table.find("[fullName]");
                var rowNum = 0;
                openSelectedPerson(veteranResult[rowNum]);
            });

            $("#SearchBirlsButton").bind("click", function () {

                $("#searchResultsMessageInput").val("");

                if (validateSearchByAlternate() == true) {
                    formatExecutingBirlsSearch();
                    var ssn = $("#SocialSecurityBirlsTextBox").val();
                    ssn = ssn.replace(/\D/g, '');  // Rescrub just incase.

                    var dob = $("#DobBirlsTextBox").val() == "MM/DD/YYY" ? "" : $("#DobBirlsTextBox").val();

                    var dateOfDeath = $("#DateOfDeathBirlsTextBox").val() == "MM/DD/YYY" ? "" : $("#DateOfDeathBirlsTextBox").val();
                    var enteredOnDutyDate = $("#EnteredOnDutyBirlsTextBox").val() == "MM/DD/YYY" ? "" : $("#EnteredOnDutyBirlsTextBox").val();
                    var releasedActiveDutyDate = $("#ReleasedActiveDutyBirlsTextBox").val() == "MM/DD/YYY" ? "" : $("#ReleasedActiveDutyBirlsTextBox").val();

                    //var filterPrefix = "$select=*&$filter=";
                    var filter = "$filter=";
                    filter += buildQueryFilter("crme_firstname", $("#FirstNameBirlsTextBox").val(), false);
                    filter += buildQueryFilter("crme_lastname", $("#LastNameBirlsTextBox").val(), true);
                    filter += buildQueryFilter("crme_ssn", ssn, true);
                    filter += buildQueryFilter("crme_dobstring", dob, true);
                    if ($("#BranchOfServiceBirlsTextBox").val() != "") filter += buildQueryFilter("crme_branchofservice", $("#BranchOfServiceBirlsTextBox").val(), true);
                    if ($("#ServiceNumberBirlsTextBox").val() != "") filter += buildQueryFilter("crme_servicenumber", $("#ServiceNumberBirlsTextBox").val(), true);
                    if ($("#InsuranceNumberBirlsTextBox").val() != "") filter += buildQueryFilter("crme_insurancenumber", $("#InsuranceNumberBirlsTextBox").val(), true);
                    if (dateOfDeath != "") filter += buildQueryFilter("crme_deceaseddate", dateOfDeath, true);
                    if (enteredOnDutyDate != "") filter += buildQueryFilter("crme_enteredondutydate", enteredOnDutyDate, true);
                    if (releasedActiveDutyDate != "") filter += buildQueryFilter("crme_releasedactivedutydate", releasedActiveDutyDate, true);
                    if ($("#SuffixBirlsTextBox").val() != "") filter += buildQueryFilter("crme_suffix", $("#SuffixBirlsTextBox").val(), true);
                    if ($("#PayeeNumberBirlsTextBox").val() != "") filter += buildQueryFilter("crme_payeenumber", $("#PayeeNumberBirlsTextBox").val(), true);
                    if ($("#FolderLocationBirlsTextBox").val() != "") filter += buildQueryFilter("crme_folderlocation", $("#FolderLocationBirlsTextBox").val(), true);

                    filter += buildQueryFilter("crme_searchtype", 'SearchByBirls', true);
                    if (interactionId != null)
                        filter += buildQueryFilter("crme_udointeractionid", interactionId, true);
                    filter += " and crme_isattended eq true";

                    //filter = encodeURIComponent(filter);
                    //filter = filterPrefix + filter;
                    //SDK.REST.retrieveMultipleRecords("crme_person", filter, personSearchCallBack, function (error) { ErrorMessage.PeopleSearch(ErrorMessage.message); }, personSearchComplete);
                    console.log("SearchBirlsButton");
                    webApi.RetrieveMultiple("crme_person", null, filter)
                        .then(
                            function reply(response) {
                                console.log(response);
                                personSearchCallBack(response);
                                personSearchComplete();
                            });
                } else {
                    formatValidationFailedAlternateSearch();
                }
            });

            $('#clearIdentifierFieldsButton').bind("click", function () {
                if (window.IsUSD == true) {
                    window.open("http://event/?eventName=VetSearchBegin&sessionid=" + sessionid);
                }
                $("#EdipiTextBox").val("");
                $("#validationFailedDiv").hide();
                $('div#tmpDialog').hide();
                $("#altSearchButton").attr('disabled', true);
                $("#SearchByNameButton").attr('disabled', false);
                $("#SearchByIdentifierButton").attr('disabled', false);
                $("#birlsSearchDiv").hide();
                var table = $("#personSearchResultsTable");
                table.find("thead, tr, th").remove();
                table.find("tr:gt(0)").remove();
                $("#resultsFieldSetDiv").hide();
            });

            $('#clearNameFieldsButton').bind("click", function () {
                if (window.IsUSD == true) {
                    window.open("http://event/?eventName=VetSearchBegin&sessionid=" + sessionid);
                }
                $("#FirstNameTextBox").val("");
                $("#MiddleNameTextBox").val("");
                $("#LastNameTextBox").val("");
                $("#BirthMonthTextBox").val("");
                $("#BirthDayTextBox").val("");
                $("#BirthYearTextBox").val("");
                //$("#PhoneNoTextBox").val("");
                $("#SocialSecurityTextBox").val("");
                $("#validationFailedDiv").hide();
                $("#notFoundDiv").hide();
                $("#birlsSearchDiv").hide();

                $('div#tmpDialog').hide();
                $("#altSearchButton").attr('disabled', true);
                $("#SearchByNameButton").attr('disabled', false);
                $("#SearchByIdentifierButton").attr('disabled', false);
                $("#SearchBirlsButton").attr('disabled', false);
                var table = $("#personSearchResultsTable");
                table.find("thead, tr, th").remove();
                table.find("tr:gt(0)").remove();
                $("#resultsFieldSetDiv").hide();
            });

            $("#ResetSearchBirlsButton").bind("click", function () {
                if (window.IsUSD == true) {
                    window.open("http://event/?eventName=VetSearchBegin&sessionid=" + sessionid);
                }
                $("#validationFailedDiv").hide();
                $('div#tmpDialog').hide();
                $("#SearchBirlsButton").attr('disabled', false);
                $("#notFoundDiv").hide();
                var table = $("#personSearchResultsTable");
                table.find("thead, tr, th").remove();
                table.find("tr:gt(0)").remove();
                $("#resultsFieldSetDiv").hide();
            });

            //$('#createNewVeteranButton').bind("click", createNewVeteran);

            function formatExecutingSearch() {
                if (window.IsUSD == true) {
                    window.open("http://event/?eventName=VetSearchBegin&sessionid=" + sessionid);
                }

                $('div#tmpDialog').show();
                $('div#tmpDialog').focus();
                $("#validationFailedDiv").hide();
                $("#resultsFieldSetDiv").hide();
                $("#notFoundDiv").hide();
                $("#birlsSearchDiv").hide();
                $("#searchResultsMessageInput").hide();
                $("#altSearchButton").attr('disabled', true);
                $("#SearchByNameButton").attr('disabled', true);
                $("#SearchByIdentifierButton").attr('disabled', true);
                $("#SearchBirlsButton").attr('disabled', true);
                $('#idProofCompleteButton').attr('disabled', true);
                $("#idProofVeteranCompleteButton").attr('disabled', true);
                $('#idProofFailedButton').attr('disabled', true);
                $("#clearNameFieldsButton").attr('disabled', true);
                $("#clearIdentifierFieldsButton").attr('disabled', true);
                $("#ResetSearchBirlsButton").attr('disabled', true);
                $("#idProofCompleteButton").show();
                $("#idProofVeteranCompleteButton").show();
                $("#idProofFailedButton").show();
            }

            function formatValidationFailed() {
                $("#validationFailedDiv").show();
                $("#validationFailedDiv").focus();
                $("#notFoundDiv").hide();
                $("#birlsSearchDiv").hide();
                $("#resultsFieldSetDiv").hide();
                $("#searchResultsMessageInput").hide();
                $("#personSearchResultsTable").find("thead, tr, th").remove();
                $("#personSearchResultsTable").find("tr:gt(0)").remove();
            }

            function formatValidationFailedAlternateSearch() {
                $("#validationFailedDiv").show();
                $("#validationFailedDiv").focus();
                $("#resultsFieldSetDiv").hide();
                $("#searchResultsMessageInput").hide();
                $("#personSearchResultsTable").find("thead, tr, th").remove();
                $("#personSearchResultsTable").find("tr:gt(0)").remove();
            }

            function formatExecutingBirlsSearch() {
                if (window.IsUSD == true) {
                    window.open("http://event/?eventName=VetSearchBegin&sessionid=" + sessionid);
                }
                $('div#tmpDialog').show();
                $('div#tmpDialog').focus();
                $("#validationFailedDiv").hide();
                $("#resultsFieldSetDiv").hide();
                $("#searchResultsMessageInput").hide();
                $("#altSearchButton").attr('disabled', true);
                $("#SearchByNameButton").attr('disabled', true);
                $("#SearchByIdentifierButton").attr('disabled', true);
                $("#SearchBirlsButton").attr('disabled', true);
                $('#idProofCompleteButton').attr('disabled', true);
                $('#idProofVeteranCompleteButton').attr('disabled', true);
                $('#idProofFailedButton').attr('disabled', true);
                $("#notFoundDiv").show();
            }

            function personSearchComplete() {
                $('div#tmpDialog').hide();
                $("#altSearchButton").attr('disabled', false);
                $("#SearchByNameButton").attr('disabled', false);
                $("#SearchByIdentifierButton").attr('disabled', false);
                $("#SearchBirlsButton").attr('disabled', false);
                $("#clearNameFieldsButton").attr('disabled', false);
                $("#clearIdentifierFieldsButton").attr('disabled', false);
                $("#ResetSearchBirlsButton").attr('disabled', false);
                //$('#idProofCompleteButton').attr('disabled', false);
                if ($("#idProofVeteranCompleteButton").is(":visible"))
                    //$("#idProofVeteranCompleteButton").focus();
                    $("#personSearchResultsTable").focus();
                else if ($("#idProofCompleteButton").is(":visible"))
                    //$("#idProofCompleteButton").focus();
                    $("#personSearchResultsTable").focus();
                else
                    $("#searchResultsMessageInput").focus();
            }

            function chatSearchComplete() {
                //$('div#tmpDialog').hide();
            }

            function setFocus(ctrl, focus) {
                if (ctrl.val().length == 2) {
                    document.getElementById(focus).focus();
                }
            }

            function buildQueryFilter(field, value, and) {
                if (and) {
                    return " and " + field + " eq '" + value + "'";
                } else {
                    return field + " eq '" + value + "'";
                }
            }

            function openSelectedPerson(obj, idCallerAsVeteran) {
                $('#idProofCompleteButton').attr('disabled', true);
                $('#idProofVeteranCompleteButton').attr('disabled', true);
                $('#idProofFailedButton').attr('disabled', true);
                if (obj == null) {
                    $('#idProofCompleteButton').attr('disabled', false);
                    $('#idProofVeteranCompleteButton').attr('disabled', false);
                    $('#idProofFailedButton').attr('disabled', false);
                    return;
                }
                $('div#tmpDialog').show();
                $('div#tmpDialog').focus();

                //start BG code
                var userid = context.userSettings.userId;
                var formatedUserId = userid.replace(/}/gi, "").replace(/{/gi, "");
                //var columns = ['BusinessUnitId', 'va_FileNumber', '&$expand=BusinessUnitId($select=udo_VeteranSensitivityLevel)'];
                //var filter = buildQueryFilter("SystemUserId", userid, false)
                //var Vfilter = "$filter=SystemUserId eq guid'" + userid + "'";
                //var overrideId = "0A90C445-88A2-E511-9418-00155D14F3D0";
                var filter = "$select=_businessunitid_value, va_filenumber&$expand=businessunitid($select=udo_veteransensitivitylevel)&$filter=systemuserid eq " + formatedUserId;

                //SDK.REST.retrieveMultipleRecords("SystemUser", Vfilter,
                webApi.RetrieveMultiple("systemuser", null, filter)
                    .then(
                        function reply(response) {
                            console.log(response);
                            if (response != null) {
                                record = response[0];

                                var uSsn = record.va_filenumber;
                                userSL = record.businessunitid.udo_veteransensitivitylevel;
                                userSL = userSL - 752280000;
                                var ssn = obj.getAttribute("ssn");
                                if (uSsn === ssn) {

                                    $('div#tmpDialog').hide();
                                    ErrorMessage.Access("You do not have access to view your own records.");
                                }
                                else {
                                    var url = obj.getAttribute('crme_url');
                                    var udoidproofid = obj.getAttribute('udoidproofid');

                                    if (udoidproofid == "00000000-0000-0000-0000-000000000000") {
                                        ErrorMessage.IDProof("Failed to update the ID Proof status. Please try the search and ID Proof again.");
                                        $('div#tmpDialog').hide();
                                        return;
                                    }
                                    var firstnameVerified = obj.getAttribute('crme_firstnameverified');
                                    var lastnameVerified = obj.getAttribute('crme_lastnameverified');
                                    var dobVerified = obj.getAttribute('crme_dobverified');
                                    var ssidVerified = obj.getAttribute('crme_ssnverified');
                                    var bosVerified = obj.getAttribute('crme_bosverified');
                                    var udoidproofid = obj.getAttribute('udoidproofid');


                                    var idproof = {};

                                    idproof.udo_verifieddob = dobVerified;
                                    idproof.udo_verifiedfirstname = firstnameVerified;
                                    idproof.udo_verifiedlastname = lastnameVerified;
                                    idproof.udo_verifiedbranchofservice = bosVerified;
                                    idproof.udo_verifiedssn = ssidVerified;
                                    idproof.udo_idproofcomplete = true;

                                    //SDK.REST.updateRecord(udoidproofid, idproof, "udo_idproof",
                                    webApi.UpdateRecord(udoidproofid, "udo_idproof", idproof)
                                        .then(function reply(response) { console.log(response); });


                                    var parmFileNumber = obj.getAttribute("fileNumber") == null ? "" : obj.getAttribute("fileNumber");
                                    var interaction = {};

                                    if (ani) {
                                        interaction.udo_ani = ani;
                                    }

                                    interaction.udo_recordsource = obj.getAttribute("recordSource") == null ? "" : obj.getAttribute("recordSource");

                                    webApi.UpdateRecord(interactionId, "udo_interaction", interaction)
                                        .then(
                                            function () {
                                                //Send interaction to context and refresh if selecting to ID Caller as Veteran
                                                if (idCallerAsVeteran === true) {
                                                    if (window.IsUSD == true) {
                                                        window.open("http://event/?eventName=InteractionUpdateForVetCaller&sessionid=" + sessionid + "&firstName=" + interaction.udo_FirstName + "&lastName=" + interaction.udo_LastName + "&phoneNumber=" + interaction.udo_PhoneNumber + "&vetFn=" + parmFileNumber + "&recordsource=" + interaction.udo_recordsource);
                                                    }
                                                }
                                            });

                                    var interaction = {};
                                    if (obj) {
                                        interaction
                                            .udo_IdProofId = obj.getAttribute('udoidproofid') == null
                                                ? ""
                                                : obj.getAttribute('udoidproofid');
                                        interaction
                                            .udo_veteranid = obj.getAttribute('veteranId') == null
                                                ? ""
                                                : obj.getAttribute('veteranId');
                                        interaction
                                            .udo_FirstName = obj.getAttribute("firstName") == null
                                                ? ""
                                                : obj.getAttribute("firstName");
                                        interaction
                                            .udo_LastName = obj.getAttribute("lastName") == null
                                                ? ""
                                                : obj.getAttribute("lastName");
                                        interaction
                                            .udo_PhoneNumber = obj.getAttribute("phoneNumber") == null
                                                ? ""
                                                : obj.getAttribute("phoneNumber");
                                        interaction
                                            .udo_FileNumber = obj.getAttribute("fileNumber") == null
                                                ? ""
                                                : obj.getAttribute("fileNumber");
                                        interaction.udo_recordsource = obj.getAttribute("recordSource") == null ? "" : obj.getAttribute("recordSource");


                                        //If IdCallerAsVeteran button clicked, the InitiateCallerId event is fired from USD in the InteractionUpdateForVetCaller event
                                        //The USD listener appears to have sporadic problems with back to back events as executed from window.open.
                                        if (idCallerAsVeteran !== true)
                                            if (window.IsUSD == true) {
                                                window.open("http://event/?eventName=IDProofComplete&sessionid=" + sessionid + "&RelationshipToVeteran=&vetId=" + interaction.udo_veteranid + "&idProofId=" + interaction.udo_IdProofId + "&firstName=" + interaction.udo_FirstName + "&lastName=" + interaction.udo_LastName + "&phoneNumber=" + interaction.udo_PhoneNumber + "&vetFn=" + interaction.udo_FileNumber + "&recordsource=" + interaction.udo_recordsource);
                                            }
                                        $('div#tmpDialog').hide();
                                    }
                                }
                            }

                        });
                //end BG code

                return false;
            }

            function personSearchCallBack(data) {
                console.log(data);
                $('div#tmpDialog').show();
                // get the table
                var table = $("#personSearchResultsTable");

                // reset the table by removing all data rows
                table.find("thead, tr, th").remove();
                table.find("tr:gt(0)").remove();
                $("#resultsFieldSetDiv").hide();

                if (data != null && data.length > 0) {
                    if (data.length > 1) {
                        $('#idProofFailedButton').attr('disabled', true);
                        $('#idProofCompleteButton').attr('disabled', true);
                        $('#idProofVeteranCompleteButton').attr('disabled', true);
                    }
                    else {
                        $('#idProofCompleteButton').attr('disabled', false);
                        //this is a query string parameter for the VSO-like flows in USD
                        //Do not enable this button if VSO and selectAnotherVet is true
                        if (selectAnotherVet === "true")
                            $('#idProofVeteranCompleteButton').attr('disabled', true);
                        else
                            $('#idProofVeteranCompleteButton').attr('disabled', false);
                    }

                    var thead = document.createElement('thead');
                    var theadRow = document.createElement('tr');
                    var hasAlias = false;
                    var hasDeceasedDate = false;
                    var hasIdentityTheft = false;
                    var hasServiceNumber = false;
                    var hasInsuranceNumber = false;
                    var hasEnteredOnDutyDate = false;
                    var hasReleasedActiveDutyDate = false;
                    var hasMiddleName = false;
                    var hasSuffix = false;
                    var hasPayeeNumber = false;
                    var hasFolderLocation = false;
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].crme_Alias != null && data[i].crme_Alias.trim() != "")
                            hasAlias = true;
                        if (data[i].crme_DeceasedDate != null && data[i].crme_DeceasedDate.trim() != "")
                            hasDeceasedDate = true;
                        if (data[i].crme_IdentityTheft != null && data[i].crme_IdentityTheft.trim() != "")
                            hasIdentityTheft = true;
                        if (data[i].crme_ServiceNumber != null && data[i].crme_ServiceNumber.trim() != "")
                            hasServiceNumber = true;
                        if (data[i].crme_InsuranceNumber != null && data[i].crme_InsuranceNumber.trim() != "")
                            hasInsuranceNumber = true;
                        if (data[i].crme_EnteredOnDutyDate != null && data[i].crme_EnteredOnDutyDate.trim() != "")
                            hasEnteredOnDutyDate = true;
                        if (data[i].crme_ReleasedActiveDutyDate != null && data[i].crme_ReleasedActiveDutyDate.trim() != "")
                            hasReleasedActiveDutyDate = true;
                        if (data[i].crme_MiddleName != null && data[i].crme_MiddleName.trim() != "")
                            hasMiddleName = true;
                        if (data[i].crme_Suffix != null && data[i].crme_Suffix.trim() != "")
                            hasSuffix = true;
                        if (data[i].crme_PayeeNumber != null && data[i].crme_PayeeNumber.trim() != "")
                            hasPayeeNumber = true;
                        if (data[i].crme_FolderLocation != null && data[i].crme_FolderLocation.trim() != "")
                            hasFolderLocation = true;
                    }

                    for (var i = 0; i < data.length; i++) {

                        var fullName = formatName(data[i]);
                        //CRMe can return result, even if just ReturnMessage that there were no results...
                        //If blank\no name, break
                        if (fullName.trim() == "") {
                            $("#resultsFieldSetDiv").show();
                            //If CorpDb down, message could be: "BIRLS communication is down" or "The Tuxedo service is down" or "Communication to the back end services is currently down. Please try again."
                            //If MVI Down: A connection error was encountered performing the MVI search.
                            //Another MVI error: "An unknown error was returned from MVI. "
                            //If cannot communicate with VIMT (plugin gets null response), plugin will output:
                            //An error occurred trying to process this request. Please try again.  If it continues to fail, please contact your administator
                            var returnMsg = (data != null && data.length > 0 && data[0].crme_returnmessage != null) ? data[0].crme_returnmessage : "Your search in MVI did not find any records matching the search criteria.";
                            if (returnMsg.indexOf("access violation") > -1 ||
                                returnMsg.indexOf("sensitive record check error") > -1 ||
                                returnMsg.indexOf("BIRLS communication is down") > -1 ||
                                returnMsg.indexOf("The Tuxedo service is down") > -1 ||
                                returnMsg.indexOf("An unknown error was encountered during the CORPDB search") > -1 ||
                                returnMsg.indexOf("An error occurred trying to process this request") > -1 ||
                                returnMsg.indexOf("Communication to the back end services is currently down. Please try again.") > -1) {
                                //if (returnMsg.indexOf("access violation") > -1 || returnMsg.indexOf("sensitive record check error") > -1) {
                                $("#idProofCompleteButton").hide();
                                $("#idProofVeteranCompleteButton").hide();
                                $("#idProofFailedButton").hide();
                                //break from for-loop. After breaking, we show the Search Message text
                                //this will not show Alternate Search since we had an error of some sort during search
                                break;
                            }

                            $("#birlsSearchDiv").show();
                            $("#idProofCompleteButton").hide();
                            $("#idProofVeteranCompleteButton").hide();
                            $("#idProofFailedButton").hide();
                            //break from for-loop. After breaking, we show the Search Message text
                            break;
                        }
                        var dateOfBirth = data[i].crme_dobstring == null ? "" : data[i].crme_dobstring;
                        var address = formatAddress(data[i]);
                        var icn = data[i].crme_icn == null ? "" : data[i].crme_icn;
                        var patientMviIdentifier = data[i].crme_patientmviidentifier == null ? "" : data[i].crme_patientmviidentifier;
                        var recordSource = data[i].crme_recordsource == null ? "" : data[i].crme_recordsource;
                        var edipi = data[i].crme_edipi == null ? "" : data[i].crme_edipi;
                        var ssn = data[i].crme_ssn == null ? "" : data[i].crme_ssn;
                        var firstName = data[i].crme_firstname == null ? "" : data[i].crme_firstname;
                        var middleName = data[i].crme_middlename == null ? "" : data[i].crme_middlename;
                        var lastName = data[i].crme_lastname == null ? "" : data[i].crme_lastname;
                        var alias = data[i].crme_alias == null ? "" : data[i].crme_alias;
                        var gender = data[i].crme_gender == null ? "" : data[i].crme_gender;
                        var deceasedDate = data[i].crme_deceaseddate == null ? "" : data[i].crme_deceaseddate;
                        var identityTheft = data[i].crme_identitytheft == null ? "" : data[i].crme_identitytheft;
                        var vetSensLevel = data[i].crme_veteransensitivitylevel == null ? "" : data[i].crme_veteransensitivitylevel;
                        var branchOfService = data[i].crme_branchofservice == null ? "" : data[i].crme_branchofservice;
                        var rank = data[i].crme_rank == null ? "" : data[i].crme_rank;
                        var serviceNumber = data[i].crme_servicenumber == null ? "" : data[i].crme_servicenumber;
                        var insuranceNumber = data[i].crme_insurancenumber == null ? "" : data[i].crme_insurancenumber;
                        var enteredOnDutyDate = data[i].crme_enteredondutydate == null ? "" : data[i].crme_enteredondutydate;
                        var releasedActiveDutyDate = data[i].crme_releasedactivedutydate == null ? "" : data[i].crme_releasedactivedutydate;
                        var suffix = data[i].crme_suffix == null ? "" : data[i].crme_suffix;
                        var payeeNumber = data[i].crme_payeenumber == null ? "" : data[i].crme_payeenumber;
                        var folderLocation = data[i].crme_folderlocation == null ? "" : data[i].crme_folderlocation;
                        var udoidproofid = data[i].crme_udoidproofid == null ? "" : data[i].crme_udoidproofid;
                        var veteranId = data[i].crme_personid == null ? "" : data[i].crme_personid;
                        var prefix = data[i].crme_prefix == null ? "" : data[i].crme_prefix;
                        var participantId = data[i].crme_participantid == null ? "" : data[i].crme_participantid;
                        var fileNumber = data[i].crme_filenumber == null ? "" : data[i].crme_filenumber;
                        var phoneNumber = data[i].crme_primaryphone == null ? "" : data[i].crme_primaryphone;
                        var windowtoOpen = "http://event/?eventName=VetSearchComplete&sessionid=" +
                            sessionid +
                            "&vetId=" +
                            veteranId +
                            "&idProofId=" +
                            udoidproofid +
                            "&vetFn=" +
                            fileNumber +
                            "&InteractionId=" +
                            interactionId;
                        if (!interactionId) {
                            interactionId = data[i].crme_udointeractionid == null ? "" : data[i].crme_udointeractionid;
                            windowtoOpen = "http://event/?eventName=VetSearchComplete&sessionid=" + sessionid + "&vetId=" + veteranId + "&idProofId=" + udoidproofid + "&vetFn=" + fileNumber + "&InteractionId=" + interactionId;
                        }
                        if (data.length === 1) {
                            //only provide warning if single result which can be idProofd
                            if (!fileNumber || !participantId || participantId === 0)
                                ErrorMessage.Warning("Warning: the File Number or Participant ID is empty for the record retrieved!");
                            window.open(windowtoOpen);
                            //window.open("http://event/?eventName=VetSearchComplete&vetId=" + veteranId + "&idProofId=" + udoidproofid + "&vetFn=" + fileNumber);

                        }
                        if (i == 0) {
                            var th0 = document.createElement('th');
                            th0.setAttribute("SCOPE", "col");
                            var th1 = document.createElement('th');
                            th1.setAttribute("SCOPE", "col");
                            var th2 = document.createElement('th');
                            th2.setAttribute("SCOPE", "col");
                            var th2_1 = document.createElement('th');
                            th2_1.setAttribute("SCOPE", "col");
                            var th3 = document.createElement('th');
                            th3.setAttribute("SCOPE", "col");
                            var th3_1 = document.createElement('th');
                            th3_1.setAttribute("SCOPE", "col");
                            var thAlias = document.createElement('th');
                            thAlias.setAttribute("SCOPE", "col");
                            var th4 = document.createElement('th');
                            th4.setAttribute("SCOPE", "col");
                            var th5 = document.createElement('th');
                            th5.setAttribute("SCOPE", "col");
                            var th5_1 = document.createElement('th');
                            th5_1.setAttribute("SCOPE", "col");
                            var th6 = document.createElement('th');
                            th6.setAttribute("SCOPE", "col");
                            var th7 = document.createElement('th');
                            th7.setAttribute("SCOPE", "col");
                            var th8 = document.createElement('th');
                            th8.setAttribute("SCOPE", "col");
                            var th10 = document.createElement('th');
                            th10.setAttribute("SCOPE", "col");
                            var th11 = document.createElement('th');
                            th11.setAttribute("SCOPE", "col");
                            var th12 = document.createElement('th');
                            th12.setAttribute("SCOPE", "col");
                            var th13 = document.createElement('th');
                            th13.setAttribute("SCOPE", "col");
                            var th14 = document.createElement('th');
                            th14.setAttribute("SCOPE", "col");
                            var th15 = document.createElement('th');
                            th15.setAttribute("SCOPE", "col");
                            var th16 = document.createElement('th');
                            th16.setAttribute("SCOPE", "col");
                            var th17 = document.createElement('th');
                            th17.setAttribute("SCOPE", "col");
                            var th18 = document.createElement('th');
                            th18.setAttribute("SCOPE", "col");
                            var th19 = document.createElement('th');
                            th19.setAttribute("SCOPE", "col");
                            var th20 = document.createElement('th');
                            th20.setAttribute("SCOPE", "col");

                            th0.appendChild(document.createTextNode('Select'));
                            th1.appendChild(document.createTextNode('SSN'));
                            th2.appendChild(document.createTextNode('First Name'));
                            th2_1.appendChild(document.createTextNode('Middle Name'));
                            th3.appendChild(document.createTextNode('Last Name'));
                            th3_1.appendChild(document.createTextNode('Suffix'));
                            thAlias.appendChild(document.createTextNode('Alias'));
                            th4.appendChild(document.createTextNode('Date of Birth'));
                            th5.appendChild(document.createTextNode('Br. of Svc'));
                            th5_1.appendChild(document.createTextNode('Rank'));
                            th6.appendChild(document.createTextNode('Gender'));
                            th7.appendChild(document.createTextNode('Deceased Date'));
                            th8.appendChild(document.createTextNode('Address'));
                            th10.appendChild(document.createTextNode('EDIPI'));
                            th11.appendChild(document.createTextNode('Identity Theft'));
                            th12.appendChild(document.createTextNode('Sens. Level'));
                            th13.appendChild(document.createTextNode('Source'));
                            th14.appendChild(document.createTextNode('Service No'));
                            th15.appendChild(document.createTextNode('Insurance No'));
                            th16.appendChild(document.createTextNode('Entered On Duty'));
                            th17.appendChild(document.createTextNode('Released Active Duty'));
                            //th18.appendChild(document.createTextNode('Suffix'));
                            th19.appendChild(document.createTextNode('Payee No'));
                            th20.appendChild(document.createTextNode('Folder Loc'));

                            if (data.length > 1)
                                theadRow.appendChild(th0);
                            theadRow.appendChild(th1);
                            theadRow.appendChild(th2);
                            if (hasMiddleName)
                                theadRow.appendChild(th2_1);
                            theadRow.appendChild(th3);
                            if (hasSuffix)
                                theadRow.appendChild(th3_1);
                            if (hasAlias) {
                                theadRow.appendChild(thAlias);
                            }
                            //theadRow.appendChild(th3);
                            theadRow.appendChild(th4);
                            theadRow.appendChild(th5);
                            theadRow.appendChild(th5_1);
                            theadRow.appendChild(th6);
                            if (hasDeceasedDate) {
                                theadRow.appendChild(th7);
                            }
                            theadRow.appendChild(th8);
                            theadRow.appendChild(th10);
                            if (hasIdentityTheft) {
                                theadRow.appendChild(th11);
                            }
                            theadRow.appendChild(th12);
                            theadRow.appendChild(th13);
                            if (hasServiceNumber)
                                theadRow.appendChild(th14);
                            if (hasInsuranceNumber)
                                theadRow.appendChild(th15);
                            if (hasEnteredOnDutyDate)
                                theadRow.appendChild(th16);
                            if (hasReleasedActiveDutyDate)
                                theadRow.appendChild(th17);
                            if (hasPayeeNumber)
                                theadRow.appendChild(th19);
                            if (hasFolderLocation)
                                theadRow.appendChild(th20);
                            thead.appendChild(theadRow);
                        }

                        // Table rows
                        var row = document.createElement('tr');
                        var col0 = document.createElement('td');
                        col0.setAttribute("SCOPE", "row");
                        var col1 = document.createElement('td');
                        col1.setAttribute("SCOPE", "row");
                        var col2 = document.createElement('td');
                        col2.setAttribute("SCOPE", "row");
                        var col2_1 = document.createElement('td');
                        col2_1.setAttribute("SCOPE", "row");
                        var col3 = document.createElement('td');
                        col3.setAttribute("SCOPE", "row");
                        var col3_1 = document.createElement('td');
                        col3_1.setAttribute("SCOPE", "row");
                        var colAlias = document.createElement('td');
                        colAlias.setAttribute("SCOPE", "row");
                        var col4 = document.createElement('td');
                        col4.setAttribute("SCOPE", "row");
                        var col5 = document.createElement('td');
                        col5.setAttribute("SCOPE", "row");
                        var col5_1 = document.createElement('td');
                        col5_1.setAttribute("SCOPE", "row");
                        var col6 = document.createElement('td');
                        col6.setAttribute("SCOPE", "row");
                        var col7 = document.createElement('td');
                        col7.setAttribute("SCOPE", "row");
                        var col8 = document.createElement('td');
                        col8.setAttribute("SCOPE", "row");
                        var col10 = document.createElement('td');
                        col10.setAttribute("SCOPE", "row");
                        var col11 = document.createElement('td');
                        col11.setAttribute("SCOPE", "row");
                        var col12 = document.createElement('td');
                        col12.setAttribute("SCOPE", "row");
                        var col13 = document.createElement('td');
                        col13.setAttribute("SCOPE", "row");
                        var col14 = document.createElement('td');
                        col14.setAttribute("SCOPE", "row");
                        var col15 = document.createElement('td');
                        col15.setAttribute("SCOPE", "row");
                        var col16 = document.createElement('td');
                        col16.setAttribute("SCOPE", "row");
                        var col17 = document.createElement('td');
                        col17.setAttribute("SCOPE", "row");
                        //var col18 = document.createElement('td');
                        var col19 = document.createElement('td');
                        col19.setAttribute("SCOPE", "row");
                        var col20 = document.createElement('td');
                        col20.setAttribute("SCOPE", "row");

                        var selectorButton = document.createElement("Button");
                        //selectorButton.setAttribute("type", "button");
                        selectorButton.setAttribute("aria-label", "Veteran Selector button for: " + fullName);
                        selectorButton.setAttribute("id", "selectorButton" + i);
                        selectorButton.setAttribute("tabindex", 100 + 10 * i - 1);
                        selectorButton.setAttribute("rowNum", i);
                        selectorButton.innerText = "Select";
                        col0.appendChild(selectorButton);
                        selectorButton.onclick = onSelectorButtonClick;

                        if (data.length == 1) {
                            var ssnIdProofCheckbox = document.createElement("INPUT");
                            ssnIdProofCheckbox.setAttribute("type", "checkbox");
                            ssnIdProofCheckbox.setAttribute("aria-label", "SSN ID Proof checkbox: " + ssn);
                            ssnIdProofCheckbox.setAttribute("id", "nameIdProofCheckbox" + i);
                            ssnIdProofCheckbox.setAttribute("tabindex", 100 + 10 * i);
                            ssnIdProofCheckbox.setAttribute("name", "ssnVerified");
                            ssnIdProofCheckbox.setAttribute("rowNum", i);
                            ssnIdProofCheckbox.setAttribute("checked", "true");
                            ssnIdProofCheckbox.onchange = onIdProofCheckboxCheck;
                            col1.appendChild(ssnIdProofCheckbox);
                            var ssnSpan = document.createElement("SPAN");
                            ssnSpan.setAttribute("onclick", "javascript:onIdProofCheckboxTextClick('nameIdProofCheckbox" + i + "');");
                            ssnSpan.appendChild(document.createTextNode(ssn));
                            col1.appendChild(ssnSpan);
                        }
                        else
                            col1.appendChild(document.createTextNode(ssn));

                        if (data.length == 1) {
                            var firstnameIdProofCheckbox = document.createElement("INPUT");
                            firstnameIdProofCheckbox.setAttribute("type", "checkbox");
                            firstnameIdProofCheckbox.setAttribute("aria-label", "First Name ID Proof checkbox: " + fullName);
                            firstnameIdProofCheckbox.setAttribute("id", "firstnameIdProofCheckbox" + i);
                            firstnameIdProofCheckbox.setAttribute("tabindex", 101 + 10 * i);
                            firstnameIdProofCheckbox.setAttribute("name", "firstnameVerified");
                            firstnameIdProofCheckbox.setAttribute("rowNum", i);
                            firstnameIdProofCheckbox.setAttribute("checked", "true");
                            firstnameIdProofCheckbox.onchange = onIdProofCheckboxCheck;
                            col2.appendChild(firstnameIdProofCheckbox);
                            var firstnameSpan = document.createElement("SPAN");
                            firstnameSpan.setAttribute("onclick", "javascript:onIdProofCheckboxTextClick('firstnameIdProofCheckbox" + i + "');");
                            firstnameSpan.appendChild(document.createTextNode(firstName));
                            col2.appendChild(firstnameSpan);
                        }
                        else
                            col2.appendChild(document.createTextNode(firstName));

                        col2_1.appendChild(document.createTextNode(middleName))

                        if (data.length == 1) {
                            var lastnameIdProofCheckbox = document.createElement("INPUT");
                            lastnameIdProofCheckbox.setAttribute("type", "checkbox");
                            lastnameIdProofCheckbox.setAttribute("aria-label", "Last Name ID Proof checkbox: " + fullName);
                            lastnameIdProofCheckbox.setAttribute("id", "lastnameIdProofCheckbox" + i);
                            lastnameIdProofCheckbox.setAttribute("tabindex", 102 + 10 * i);
                            lastnameIdProofCheckbox.setAttribute("name", "lastnameVerified");
                            lastnameIdProofCheckbox.setAttribute("rowNum", i);
                            lastnameIdProofCheckbox.setAttribute("checked", "true");
                            lastnameIdProofCheckbox.onchange = onIdProofCheckboxCheck;
                            col3.appendChild(lastnameIdProofCheckbox);
                            var lastnameSpan = document.createElement("SPAN");
                            lastnameSpan.setAttribute("onclick", "javascript:onIdProofCheckboxTextClick('lastnameIdProofCheckbox" + i + "');");
                            lastnameSpan.appendChild(document.createTextNode(lastName));
                            col3.appendChild(lastnameSpan);
                        }
                        else
                            col3.appendChild(document.createTextNode(lastName));

                        col3_1.appendChild(document.createTextNode(suffix));

                        colAlias.appendChild(document.createTextNode(alias));

                        if (data.length == 1) {
                            var dobIdProofCheckbox = document.createElement("INPUT");
                            dobIdProofCheckbox.setAttribute("type", "checkbox");
                            dobIdProofCheckbox.setAttribute("aria-label", "Date of Birth ID Proof checkbox: " + dateOfBirth);
                            dobIdProofCheckbox.setAttribute("id", "dobIdProofCheckbox" + i);
                            dobIdProofCheckbox.setAttribute("tabindex", 103 + 10 * i);
                            dobIdProofCheckbox.setAttribute("name", "dobVerified");
                            dobIdProofCheckbox.setAttribute("rowNum", i);
                            dobIdProofCheckbox.setAttribute("checked", "true");
                            dobIdProofCheckbox.onchange = onIdProofCheckboxCheck;
                            col4.appendChild(dobIdProofCheckbox);
                            var dobSpan = document.createElement("SPAN");
                            dobSpan.setAttribute("onclick", "javascript:onIdProofCheckboxTextClick('dobIdProofCheckbox" + i + "');");
                            dobSpan.appendChild(document.createTextNode(dateOfBirth));
                            col4.appendChild(dobSpan);
                        }
                        else
                            col4.appendChild(document.createTextNode(dateOfBirth));

                        var longBranchofService = LongBranchOfService(branchOfService);
                        if (data.length == 1) {
                            var bosIdProofCheckbox = document.createElement("INPUT");
                            bosIdProofCheckbox.setAttribute("type", "checkbox");
                            bosIdProofCheckbox.setAttribute("aria-label", "Branch of Service ID Proof checkbox: " + longBranchofService);
                            bosIdProofCheckbox.setAttribute("id", "bosIdProofCheckbox" + i);
                            bosIdProofCheckbox.setAttribute("tabindex", 104 + 10 * i);
                            bosIdProofCheckbox.setAttribute("name", "bosVerified");
                            bosIdProofCheckbox.setAttribute("rowNum", i);
                            bosIdProofCheckbox.setAttribute("checked", "true");
                            bosIdProofCheckbox.onchange = onIdProofCheckboxCheck;
                            col5.appendChild(bosIdProofCheckbox);
                            var bosSpan = document.createElement("SPAN");
                            bosSpan.setAttribute("onclick", "javascript:onIdProofCheckboxTextClick('bosIdProofCheckbox" + i + "');");
                            bosSpan.appendChild(document.createTextNode(longBranchofService));
                            col5.appendChild(bosSpan);
                        }
                        else
                            col5.appendChild(document.createTextNode(longBranchofService));

                        col5_1.appendChild(document.createTextNode(rank));
                        col6.appendChild(document.createTextNode(gender));
                        col7.appendChild(document.createTextNode(deceasedDate));
                        col8.appendChild(document.createTextNode(address));

                        col10.appendChild(document.createTextNode(edipi));
                        col11.appendChild(document.createTextNode(identityTheft));
                        col12.appendChild(document.createTextNode(vetSensLevel));
                        col13.appendChild(document.createTextNode(recordSource));
                        col14.appendChild(document.createTextNode(serviceNumber));
                        col15.appendChild(document.createTextNode(insuranceNumber));
                        col16.appendChild(document.createTextNode(enteredOnDutyDate));
                        col17.appendChild(document.createTextNode(releasedActiveDutyDate));
                        //col18.appendChild(document.createTextNode(suffix));
                        col19.appendChild(document.createTextNode(payeeNumber));
                        col20.appendChild(document.createTextNode(folderLocation));

                        if (data.length > 1)
                            row.appendChild(col0);
                        row.appendChild(col1);
                        row.appendChild(col2);
                        if (hasMiddleName)
                            row.appendChild(col2_1);
                        row.appendChild(col3);
                        if (hasSuffix)
                            row.appendChild(col3_1);
                        if (hasAlias) {
                            row.appendChild(colAlias);
                        }

                        row.appendChild(col4);
                        row.appendChild(col5);
                        row.appendChild(col5_1);
                        row.appendChild(col6);
                        if (hasDeceasedDate) {
                            row.appendChild(col7);
                        }
                        row.appendChild(col8);
                        row.appendChild(col10);
                        if (hasIdentityTheft) {
                            row.appendChild(col11);
                        }
                        row.appendChild(col12);
                        row.appendChild(col13);
                        if (hasServiceNumber)
                            row.appendChild(col14);
                        if (hasInsuranceNumber)
                            row.appendChild(col15);
                        if (hasEnteredOnDutyDate)
                            row.appendChild(col16);
                        if (hasReleasedActiveDutyDate)
                            row.appendChild(col17);
                        //if (hasSuffix)
                        //    row.appendChild(col18);
                        if (hasPayeeNumber)
                            row.appendChild(col19);
                        if (hasFolderLocation)
                            row.appendChild(col20);

                        row.setAttribute('fullName', fullName);
                        row.setAttribute('dateofbirth', dateOfBirth);
                        row.setAttribute('fulladdress', address);
                        row.setAttribute('ssn', ssn);
                        row.setAttribute('edipi', edipi);
                        row.setAttribute('recordSource', recordSource);
                        row.setAttribute('firstName', firstName);
                        row.setAttribute('middleName', middleName);
                        row.setAttribute('lastName', lastName);
                        row.setAttribute('suffix', suffix);
                        row.setAttribute('gender', gender);
                        row.setAttribute('patientMviIdentifier', patientMviIdentifier);
                        row.setAttribute('icn', icn);
                        row.setAttribute('vetSensLevel', vetSensLevel);
                        row.setAttribute('crme_firstnameverified', true);
                        row.setAttribute('crme_lastnameverified', true);
                        row.setAttribute('crme_dobverified', true);
                        row.setAttribute('crme_genderverified', true);
                        row.setAttribute('crme_ssnverified', true);
                        row.setAttribute('crme_bosverified', true);
                        row.setAttribute('udoidproofid', udoidproofid);
                        row.setAttribute('veteranId', veteranId);
                        row.setAttribute('rowIdNum', i);
                        row.setAttribute('alias', alias);
                        row.setAttribute('deceasedDate', deceasedDate);
                        row.setAttribute('identityTheft', identityTheft);
                        row.setAttribute('prefix', prefix);
                        row.setAttribute('participantId', participantId);
                        row.setAttribute('fileNumber', fileNumber);
                        row.setAttribute('phoneNumber', phoneNumber);
                        row.className = (i % 2 == 0) ? "even" : "odd";

                        row.tabIndex = 100 + 10 * i;
                        table.append(thead);
                        table.append(row);

                        $("#resultsFieldSetDiv").show();
                        $("#idProofCompleteButton").show();
                        $("#idProofVeteranCompleteButton").show();
                        $("#idProofFailedButton").show();

                    }
                }
                else {
                    //Even if there are no person records as a result of the crme_person retrieve,
                    //the return message should be populated as part of the crme_person
                    //therefore, the only time we should get here is if there is an error on the VIMT call
                    $("#idProofCompleteButton").hide();
                    $("#idProofVeteranCompleteButton").hide();
                    $("#idProofFailedButton").hide();
                    var searchMessage = $("#searchResultsMessageInput");
                    searchMessage.val("A connection error was encountered during the search. Please try the search again and contact the helpdesk if the issue is not resolved.");
                    $("#resultsFieldSetDiv").show();

                    var fieldLength = searchMessage.val().length;
                    searchMessage.attr('size', fieldLength);
                    searchMessage.show();

                }
                var searchMessage = $("#searchResultsMessageInput");
                searchMessage.val((data != null && data.length > 0 && data[0].crme_returnmessage != null) ? data[0].crme_returnmessage : "Your search in MVI did not find any records matching the search criteria.");
                if (searchMessage.val().indexOf("access violation") > -1 || searchMessage.text().indexOf("sensitive record check error") > -1) {

                    var violationSplit = searchMessage.val().split("!");
                    var sensitiveLevelMessage;

                    if (violationSplit.length > 1) {
                        sensitiveLevelMessage = violationSplit[1].charAt(0).toUpperCase() + violationSplit[1].slice(1);
                    }

                    searchMessage.val("You are trying to access a record above your allocated sensitivity level. Please transfer the call to your supervisor to support the needs of the veteran. " + sensitiveLevelMessage + ".");

                    //searchMessage.val("You are trying to access a record above your allocated sensitivity level. Please transfer the call to your supervisor to support the needs of the veteran.");
                    //searchMessage.text("Sensitivity Level Error");
                }
                else
                    if (searchMessage.val().indexOf("BIRLS communication is down") > -1 || searchMessage.text().indexOf("The Tuxedo service is down") > -1) {
                        searchMessage.val("A connection error was encountered during the CORPDB search: " + searchMessage.text());
                    }
                var fieldLength = searchMessage.val().length;
                searchMessage.attr('size', fieldLength);
                searchMessage.show();
            }

            function onSelectorButtonClick() {
                $("#searchResultsMessageInput").val("");
                formatExecutingSearch();

                idProofId = null;
                veteranId = null;
                var table = $("#personSearchResultsTable");
                var obj = this;
                var rowNum = obj.getAttribute("rowNum");
                var row = table.find("[rowIdNum=" + rowNum + "]");

                var fullName = row[0].getAttribute('fullName');
                var dob = row[0].getAttribute('dateofbirth');
                var address = row[0].getAttribute('fulladdress');
                var ssn = row[0].getAttribute('ssn');
                var fileNumber = row[0].getAttribute('fileNumber');
                var edipi = row[0].getAttribute('edipi');
                var recordSource = row[0].getAttribute('recordSource');
                var firstName = row[0].getAttribute('firstName');
                var middleName = row[0].getAttribute('middleName');
                var lastName = row[0].getAttribute('lastName');
                var suffix = row[0].getAttribute('suffix');
                var gender = row[0].getAttribute('gender');
                var patientMviIdentifier = row[0].getAttribute('patientMviIdentifier');
                var icn = row[0].getAttribute('icn');

                var alias = row[0].getAttribute('alias');
                var deceasedDate = row[0].getAttribute('deceasedDate');
                var identityTheft = row[0].getAttribute('identityTheft');
                var prefix = row[0].getAttribute('prefix');
                var participantId = row[0].getAttribute('participantId');
                var phoneNumber = row[0].getAttribute('phoneNumber');
                var vetSensitivityLevel = row[0].getAttribute('vetSensLevel');

                //var filterPrefix = "$select=*&$filter=";
                var filter = "$filter=";
                filter += buildQueryFilter("crme_firstname", firstName, false);
                filter += buildQueryFilter("crme_lastname", lastName, true);
                filter += buildQueryFilter("crme_searchtype", 'CombinedSelectedPerson', true);
                if (interactionId != null)
                    filter += buildQueryFilter("crme_udointeractionid", interactionId, true);
                filter += " and crme_isattended eq true";
                filter += " and crme_dobstring eq '" + dob + "'";
                filter += buildQueryFilter("crme_filenumber", fileNumber, true);
                filter += buildQueryFilter("crme_ssn", ssn, true);
                filter += buildQueryFilter("crme_patientmviidentifier", patientMviIdentifier, true);
                filter += buildQueryFilter("crme_icn", icn, true);
                filter += buildQueryFilter("crme_middlename", middleName, true);
                filter += buildQueryFilter("crme_fullname", fullName, true);
                filter += buildQueryFilter("crme_alias", alias, true);
                filter += buildQueryFilter("crme_fulladdress", address, true);
                filter += buildQueryFilter("crme_recordsource", recordSource, true);
                filter += buildQueryFilter("crme_edipi", edipi, true);
                filter += buildQueryFilter("crme_suffix", suffix, true);
                filter += buildQueryFilter("crme_gender", gender, true);
                filter += buildQueryFilter("crme_prefix", prefix, true);
                filter += buildQueryFilter("crme_deceaseddate", deceasedDate, true);
                filter += buildQueryFilter("crme_identitytheft", identityTheft, true);
                filter += buildQueryFilter("crme_participantid", participantId, true);
                filter += buildQueryFilter("crme_primaryphone", phoneNumber, true);
                filter += buildQueryFilter("crme_veteransensitivitylevel", vetSensitivityLevel, true);
                console.log(filter);
                //filter = encodeURIComponent(filter);
                //filter = filterPrefix + filter;
                //SDK.REST.retrieveMultipleRecords("crme_person", filter, personSearchCallBack, function (error) { ErrorMessage.PeopleSearch(ErrorMessage.message); }, personSearchComplete);
                webApi.RetrieveMultiple("crme_person", null, filter)
                    .then(
                        function (data) {
                            personSearchCallBack(data);
                            personSearchComplete();
                        }
                    );
            }

            function onIdProofCheckboxCheck() {
                if (idProofCheckboxesChecked(this) == true) {
                    $('#idProofCompleteButton').attr('disabled', false);
                    if (selectAnotherVet === "true")
                        $('#idProofVeteranCompleteButton').attr('disabled', true);
                    else
                        $('#idProofVeteranCompleteButton').attr('disabled', false);
                    $('#idProofFailedButton').attr('disabled', true);
                }
                else {
                    $('#idProofCompleteButton').attr('disabled', true);
                    $('#idProofVeteranCompleteButton').attr('disabled', true);
                    $('#idProofFailedButton').attr('disabled', false);
                }
            }

            function idProofCheckboxesChecked(obj) {
                var table = $("#personSearchResultsTable");
                var rowNum = obj.getAttribute("rowNum");
                var row = table.find("[rowIdNum=" + rowNum + "]");

                switch (obj.name) {
                    case "firstnameVerified":
                        row[0].setAttribute('crme_firstnameverified', obj.checked);
                        break;
                    case "lastnameVerified":
                        row[0].setAttribute('crme_lastnameverified', obj.checked);
                        break;
                    case "dobVerified":
                        row[0].setAttribute('crme_dobverified', obj.checked);
                        break;
                    case "ssnVerified":
                        row[0].setAttribute('crme_ssnverified', obj.checked);
                        break;
                    case "bosVerified":
                        row[0].setAttribute('crme_bosverified', obj.checked);
                        break;
                }
                var checkboxes = $("[id*='IdProofCheckbox" + rowNum + "']");
                for (var key in checkboxes) {
                    if (checkboxes[key].checked === false)
                        return false;
                }
                return true;
            }

            function formatDatePart(datepart) {
                return datepart.length == 1 ? "0" + datepart : datepart;
            }

            function formatName(data) {
                if (data.crme_fullname != null && data.crme_fullname.trim().length > 0) {
                    return data.crme_fullname;
                }

                var firstName = (data.crme_fullname != null && data.crme_firstname.trim().length > 0) ? data.crme_firstname : "";
                var lastName = (data.crme_fullname != null && data.crme_lastname.trim().length > 0) ? data.crme_lastname : "";
                //var firstName = (data.crme_fullname == null && data.crme_firstname.trim().length > 0) ? data.crme_firstname : "";
                //var lastName = (data.crme_fullname == null && data.crme_lastname.trim().length > 0) ? data.crme_lastname : "";

                return firstName + " " + lastName;
            }

            function formatAddress(data) {
                if (data.crme_fulladdress != null) {
                    return data.crme_fulladdress;
                }

                var street = data.crme_address1 != null ? data.crme_address1 : "";
                var city = data.crme_city != null ? data.crme_city : "";
                //TODO: JK field not on entity
                //var state = data.crme_stateprovinceid.Name != null ? data.crme_StateProvinceId.Name : "";

                //TODO: JK field not on entity
                //var zip = data.crme_ZIPPostalCodeId.Name != null ? data.crme_ZIPPostalCodeId : "";

                //return street + " " + city + " " + state + " " + zip;
                return street + " " + city;
            }


            var userSL;

            function validateSearchByIdentifier() {
                var edipi = $("#EdipiTextBox").val();

                if (edipi != "") {
                    if (((edipi.length < 9 || edipi.length > 10) || isNumeric(edipi) == false)) {
                        $("#validationFailedDiv").text("VALIDATION FAILED: EDIPI is invalid.");
                        return false;
                    }
                    return true;
                }
                else {
                    $("#validationFailedDiv").text("VALIDATION FAILED: The search requires an EDIPI.");
                    return false;
                }
            }

            // Taken from: UDOgetContactRecordsProcessor.cs
            function LongBranchOfService(branchcode) {
                switch (branchcode.trim()) {
                    case "AF": return "AIR FORCE (AF)";
                    case "A": return "ARMY (ARMY)";
                    //ARMY AIR CORPS
                    case "CG": return "COAST GUARD (CG)";
                    case "CA": return "COMMONWEALTH ARMY (CA)";
                    case "GCS": return "GUERRILLA AND COMBINATION SVC (GCS)";
                    case "M": return "MARINES (M)";
                    case "MM": return "MERCHANT MARINES (MM)";
                    case "NOAA": return "NATIONAL OCEANIC & ATMOSPHERIC ADMINISTRATION (NOAA)";
                    //NAVY (NAVY)
                    case "PHS": return "PUBLIC HEALTH SVC (PHS)";
                    case "RSS": return "REGULAR PHILIPPINE SCOUT (RSS)";
                    //REGULAR PHILIPPINE SCOUT COMBINED WITH SPECIAL
                    case "RPS": return "PHILIPPINE SCOUT OR COMMONWEALTH ARMY SVC (RPS)";
                    case "SPS": return "SPECIAL PHILIPPINE SCOUTS (SPS)";
                    case "WAC": return "WOMEN'S ARMY CORPS (WAC)";
                }
                return branchcode;
            }

            function validateSearchByName() {
                var result = $.Deferred();
                var errors = [];
                var await = $.when();

                var fname = $("#FirstNameTextBox").val();
                var lname = $("#LastNameTextBox").val();
                var ssn = $("#SocialSecurityTextBox").val();
                // var phone = $("#PhoneNoTextBox").val();
                var dobyear = $("#BirthYearTextBox").val();
                var dobmonth = $("#BirthMonthTextBox").val();
                var dobday = $("#BirthDayTextBox").val();
                var dob = dobyear + dobmonth + dobday;

                var fields = [];

                if (ssn == null || ssn.trim() == "") fields.push("'SSN'");
                if (lname == null || lname == "") fields.push("'last name'");
                if (dob == null || dob.trim() == "" || !isNumeric(dob.trim())) fields.push("'DOB'");

                if (fields.length > 0) {
                    var p = fields.length > 1;
                    errors.push(fields.join(", ") + " field" + (p ? 's' : '') + ' ' + (p ? 'are' : 'is') + ' required.');
                    fields = [];
                }

                ssn = ssn.replace(/-/g, "").trim();

                var ssnDigits = ssn.trim().length;
                if (ssnDigits == 6 || ssnDigits == 7) {
                    var message = 'You have entered ' + ssnDigits + ' digits for the SSN.\n\nWould you like to add ' + (ssnDigits == 6 ? '2' : '1') + ' preceeding zeros?';
                    await = Va.Udo.Crm.Scripts.Popup.MsgBox(message, Va.Udo.Crm.Scripts.Popup.PopupStyles.YesNo + Va.Udo.Crm.Scripts.Popup.PopupStyles.Question,
                        "SSN Validation", { width: 300, height: 165 })
                        .done(function () {
                            ssn = "0" + ssn;
                            if (ssnDigits == 6) ssn = "0" + ssn;
                            $("#SocialSecurityTextBox").val(ssn);
                        });
                }

                await.then(function () {
                    if (ssn.trim().length > 0 && (isNumeric(ssn.trim()) == false || ssn.trim().length < 8 || ssn.trim().length > 9)) errors.push("SSN is invalid.");

                    if (!validateDateOfBirth(dobyear, dobmonth, dobday)) errors.push("DOB is invalid.");

                    if (errors.length > 0) {
                        $("#validationFailedDiv").text("VALIDATION FAILED: " + errors.join(" "));
                        result.reject();
                    } else {
                        result.resolve();
                    }
                });

                return result.promise();
            }

            function validateSearchByAlternate() {
                var ssn = $("#SocialSecurityBirlsTextBox").val();
                var dob = $('#DobBirlsTextBox').val();
                var dod = $('#DateOfDeathBirlsTextBox').val();
                var eod = $('#EnteredOnDutyBirlsTextBox').val();
                var rad = $('#ReleasedActiveDutyBirlsTextBox').val();
                var errorMessage = "VALIDATION FAILED: ";
                var errorCount = 0;
                ssn = ssn.replace(/-/g, "").trim();

                //SSN is not required for BIRLS search
                if (ssn != "") {
                    if (isNumeric(ssn.trim()) == false) {
                        errorMessage += " SSN is invalid.";
                        errorCount += 1;
                    }
                }

                if (dob != "") {
                    if (!validateDateSingleField(dob)) {
                        errorMessage += " DOB is invalid.";
                        errorCount += 1;
                    }
                }
                if (dod != "") {
                    if (!validateDateSingleField(dod)) {
                        errorMessage += " Date of Death is invalid.";
                        errorCount += 1;
                    }
                }
                if (eod != "") {
                    if (!validateDateSingleField(eod)) {
                        errorMessage += " Entered on Duty is invalid.";
                        errorCount += 1;
                    }
                }
                if (rad != "") {
                    if (!validateDateSingleField(rad)) {
                        errorMessage += " Released Active Duty is invalid.";
                        errorCount += 1;
                    }
                }

                if (errorCount > 0) {
                    $("#validationFailedDiv").text(errorMessage);
                    return false;
                }


                return true;
            }

            function validateDateOfBirth(dobyear, dobmonth, dobday) {

                if ((dobyear == "" || dobyear == "YYYY") && (dobmonth == "" || dobmonth == "MM") && (dobday == "" || dobday == "DD")) {
                    return true;
                }

                if (dobyear != "YYYY" || dobmonth != "MM" || dobday != "DD") {
                    if ((dobyear != "" && isNumeric(dobyear) == false) || (dobmonth != "" && isNumeric(dobmonth) == false) || (dobday != "" && isNumeric(dobday) == false)) {
                        return false;
                    }
                }


                if (dobyear.length != 4) {
                    return false;
                }

                if (dobyear >= (new Date).getFullYear() + 1) {
                    return false;
                }

                if (dobyear < (new Date).getFullYear() - 200) {
                    return false;
                }

                if (dobmonth < 1 || dobmonth > 12) {
                    return false;
                }

                if (dobday < 1 || dobday > 31) {
                    return false;
                }

                var fullDobDate = new Date(dobyear, dobmonth - 1, dobday);
                var currFullDate = Date.now();
                if (fullDobDate >= currFullDate)
                    return false;

                return true;
            }

            function validateDateSingleField(date) {

                if (date == null || date == "")
                    return false;
                var datemonth;
                var dateday;
                var dateyear;
                var dateSplit = date.split("/");
                if (dateSplit[0] != null && isNumeric(dateSplit[0]))
                    datemonth = dateSplit[0];
                if (dateSplit[1] != null && isNumeric(dateSplit[1]))
                    dateday = dateSplit[1];
                if (dateSplit[2] != null && isNumeric(dateSplit[2]))
                    dateyear = dateSplit[2];


                if (dateyear == null || dateyear.length != 4) {
                    return false;
                }

                if (dateyear >= (new Date).getFullYear() + 1) {
                    return false;
                }

                if (dateyear < (new Date).getFullYear() - 200) {
                    return false;
                }

                if (datemonth == null || datemonth < 1 || datemonth > 12) {
                    return false;
                }

                if (dateday == null || dateday < 1 || dateday > 31) {
                    return false;
                }

                var fulldateDate = new Date(dateyear, datemonth - 1, dateday);
                var currFullDate = Date.now();
                if (fulldateDate >= currFullDate)
                    return false;

                return true;
            }

            function GetQueryParams() {
                var queryParams = Va.Udo.Crm.Scripts.Utility.getDataParameter(Va.Udo.Crm.Scripts.Utility.getQueryParameter("data"));
                if (queryParams.ChatSessionLogId)
                    chatSessionLogId = queryParams.ChatSessionLogId;

                interactionId = queryParams.InteractionId;
                selectAnotherVet = queryParams.SelectAnotherVet;
                ani = queryParams.ani;
                ctissn = queryParams.ssn;
                ctidob = queryParams.dob;
                ctiedipi = queryParams.edipi;
                sessionid = queryParams.sessionid;
            }

            function GetChatDetailsIfAvailable() {
                if (chatSessionLogId) {
                    formatExecutingSearch();
                    // var filterPrefix = "$select=*&$filter=";
                    var filter = "ActivityId eq'" + chatSessionLogId + "'";
                    //filter = encodeURIComponent(filter);
                    //filter = filterPrefix + filter;
                    //SDK.REST.retrieveMultipleRecords("crme_chatcobrowsesessionlog", filter, chatSearchCallBack, function (error) { ErrorMessage.ChatSearch(ErrorMessage.message); }, chatSearchComplete);
                    webApi.RetrieveMultiple("crme_chatbrowsesessionlog", null, filter)
                        .then(
                            function (data) {
                                chatSearchCallBack(data.entites);
                                chatSearchComplete();
                            }
                        );
                }
            }

            function chatSearchCallBack(data) {

                if (data != null && data.length > 0) {
                    var edipi = data[0].crme_EDIPI;
                    if (edipi)
                        edipi = edipi.trim();
                    var pid = data[0].crme_ParticipantId;
                    if (pid)
                        pid = pid.trim();
                    var ssn = data[0].crme_SSN;
                    if (ssn)
                        ssn = ssn.trim();
                    performSearchUsingChatParameters(edipi, pid, ssn);
                }

            }
            function performSearchUsingChatParameters(edipi, pid, ssn) {
                //var filterPrefix = "$select=*&$filter=";
                var filter = buildQueryFilter("crme_SearchType", 'CHAT', false);
                if (edipi) {
                    filter += buildQueryFilter("crme_EDIPI", edipi, true);
                    $("#EdipiTextBox").val(edipi);
                }
                if (pid)

                    filter += buildQueryFilter("crme_ParticipantID", pid, true);
                if (ssn) {
                    filter += buildQueryFilter("crme_SSN", ssn, true);
                    $("#SocialSecurityTextBox").val(ssn);
                }
                if (interactionId)
                    filter += buildQueryFilter("crme_udointeractionid", interactionId, true);
                //filter += " and crme_IsAttended eq true";
                //filter = encodeURIComponent(filter);
                //filter = filterPrefix + filter;
                //SDK.REST.retrieveMultipleRecords("crme_person", filter, personSearchCallBack, function (error) { ErrorMessage.PeopleSearch(ErrorMessage.message); }, personSearchComplete);
                webApi.RetrieveMultiple("crme_person", null, filter)
                    .then(
                        function (data) {
                            personSearchCallBack(data.entities);
                            personSearchComplete();
                        }
                    );

            }
            function performSearchUsingCTIParameters() {
                // alert("here!, ani:" + ani);
                if (ani) {
                    formatExecutingSearch();
                    //var filterPrefix = "$select=*&$filter=";
                    var filter = "$select=*&$filter=";
                    filter += buildQueryFilter("crme_searchtype", 'CTI', false);
                    if (ani)
                        filter += buildQueryFilter("crme_ani", ani, true);
                    if (ctidob) {
                        filter += buildQueryFilter("crme_dobstring", ctidob, true);
                        $("#BirthDayTextBox").val(ctidob.substring(6, 8));
                        $("#BirthYearTextBox").val(ctidob.substring(0, 4));
                        $("#BirthMonthTextBox").val(ctidob.substring(4, 6));
                    }
                    if (ctissn) {
                        filter += buildQueryFilter("crme_ssn", ctissn, true);
                        $("#SocialSecurityTextBox").val(ctissn);
                    }
                    if (ctiedipi) {
                        filter += buildQueryFilter("crme_edipi", ctiedipi, true);
                        $("#EdipiTextBox").val(ctiedipi);
                    }
                    else {
                        filter += buildQueryFilter("crme_edipi", "not", true);
                    }
                    if (interactionId)
                        filter += buildQueryFilter("crme_udointeractionid", interactionId, true);
                    //filter += " and crme_IsAttended eq true";
                    //filter = encodeURIComponent(filter);
                    //filter = filterPrefix + filter;
                    //  alert("Filter!" + filter);
                    //SDK.REST.retrieveMultipleRecords("crme_person", filter, personSearchCallBack, function (error) { ErrorMessage.PeopleSearch(ErrorMessage.message); }, personSearchComplete);

                    webApi.RetrieveMultiple("crme_person", null, filter)
                        .then(
                            function reply(response) {
                                personSearchCallBack(response);
                                personSearchComplete();
                            }).catch(function (error) {

                                console.log(error.message);
                                console.log(error.innerError.message);
                                console.log(error.innerError.stacktrace);
                                personSearchComplete();
                                formatValidationFailed();
                            });

                    //webApi.RetrieveMultiple("crme_person", null, filter)
                    //    .then(
                    //        function (data) {
                    //            personSearchCallBack(data.entities);
                    //            personSearchComplete();
                    //        })
                    //    .fail(function (error) {

                    //        formatValidationFailed();
                    //    });


                }
            }


        }); // end Document Ready

        function isNumeric(value) {

            return !isNaN(parseFloat(value) && isFinite(value));
        }

        function clearField(obj) {
            if (obj.defaultValue == obj.value) obj.value = '';
        }
    </script>


    <form id="searchByTraitsForm">
        <h1 style="padding-top: 12px;">Veteran Search</h1>
        <div class="search">
            <table>
                <tbody>
                    <tr>
                        <td class="auto-style1">
                            <h2>Section 1 - Search By Traits</h2>
                        </td>
                    </tr>
                </tbody>
            </table>
            <fieldset>
                <legend>The search criteria for a search by traits includes the Social Security Number, First Name, Last Name, and Date of Birth in MM DD YYYY format</legend>
                <table>
                    <tbody>
                        <tr>
                            <td class="auto-style1">
                                <label for="SocialSecurityTextBox">*SSN</label>
                            </td>
                            <td>
                                <label for="FirstNameTextBox">First</label>
                            </td>
                            <td>
                                <label for="LastNameTextBox">*Last</label>
                            </td>
                            <td>
                                <label for="BirthMonthTextBox">*Month</label>
                            </td>
                            <td>
                                <label for="BirthDayTextBox">*Day</label>
                            </td>
                            <td>
                                <label for="BirthYearTextBox">*Year</label>
                            </td>

                        </tr>
                        <tr>
                            <td class="auto-style1">
                                <input name="ssn" tabindex="1" title="Social Security Number (9 char max)" class="formInputText" id="SocialSecurityTextBox" required="" onfocus="clearField(this)" type="text" size="16" maxlength="50">
                            </td>
                            <td>
                                <input name="firstName" tabindex="2" title="First Name (30 char max)" class="formInputText" id="FirstNameTextBox" onfocus="clearField(this)" type="text" size="16" maxlength="30">
                            </td>
                            <td>
                                <input name="lastName" tabindex="3" title="Last Name (30 char max)" class="formInputText" id="LastNameTextBox" required="" onfocus="clearField(this)" type="text" size="16" maxlength="30">
                            </td>
                            <td>

                                <input name="dateOfBirthMonth" tabindex="4" title="DOB Month in MM format" class="formInputText" id="BirthMonthTextBox" style="height: 30px;" required="" onkeyup="if($(this).val().length == 2) $('#BirthDayTextBox').focus()" onfocus="clearField(this)" type="text" size="2" maxlength="2" placeholder="MM" pattern="[0-9]*">
                                /
                            </td>
                            <td>
                                <input name="dateOfBirthDay" tabindex="5" title="DOB Day in DD format" class="formInputText" id="BirthDayTextBox" style="height: 30px;" required="" onkeyup="if($(this).val().length == 2) $('#BirthYearTextBox').focus()" onfocus="clearField(this)" type="text" size="2" maxlength="2" placeholder="DD" pattern="[0-9]*">
                                /
                            </td>
                            <td>
                                <input name="dateOfBirthYear" tabindex="6" title="DOB Year in YYYY format" class="formInputText" id="BirthYearTextBox" style="height: 30px;" required="" onfocus="clearField(this)" type="text" size="4" maxlength="4" placeholder="YYYY" pattern="[0-9]*">
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-top: 10px;" colspan="4">
                                <button tabindex="7" id="SearchByNameButton" aria-label="Search by Traits">Search</button>
                                <button tabindex="8" id="clearNameFieldsButton" aria-label="Reset Search by Traits" type="reset">Reset</button>
                                <button tabindex="9" id="altSearchButton" aria-label="Alternate Search">Alternate Search</button>
                            </td>
                        </tr>

                    </tbody>
                </table>
            </fieldset>
        </div>
    </form>
    <form id="searchByEdipiForm">
        <div class="search">
            <table>
                <tbody>
                    <tr>
                        <td class="auto-style1">
                            <h2>Section 2 - Search By EDIPI</h2>
                        </td>
                    </tr>
                </tbody>
            </table>
            <fieldset>
                <legend>The search criteria for a search by EDIPI includes the EDIPI</legend>
                <table>
                    <tbody>
                        <tr>
                            <td>
                                <label for="EdipiTextBox">*EDIPI</label>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <input name="edipi" tabindex="10" title="EDIPI (10 char max)" class="formInputText" id="EdipiTextBox" required="" onfocus="clearField(this)" type="text" size="16" maxlength="10">
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-top: 10px;">
                                <button tabindex="11" id="SearchByIdentifierButton" aria-label="Search by EDIPI">Search</button>
                                <button tabindex="12" id="clearIdentifierFieldsButton" aria-label="Reset Search by EDIPI" type="reset">Reset</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>
        </div>
    </form>
    <br>
    <div class="search" id="validationFailedDiv" style="color: rgb(128, 0, 0); clear: both; font-size: 1em; font-weight: bold; display: none;" aria-label="Search validation failed message">The search requires some additional information. Please follow the instructions above to execute your search.</div>
    <div tabindex="50" class="search" id="resultsFieldSetDiv" style="width: 100%; float: left; display: none;">
        <h2>Section 3 - Search Results</h2>
        <div class="search" style="clear: both;"></div>
        <div id="searchResultsMessageDiv"><input tabindex="51" class="search" id="searchResultsMessageInput" style="border: currentColor; color: rgb(128, 0, 0); font-size: 1em; font-weight: bold; display: none;" type="text" readonly="readonly"></div>
        <fieldset id="SearchResultFieldSet">
            <legend style="display: none;">Search Results</legend>
            <table id="personSearchResultsTable" style="width: 100%;"></table>
            <button tabindex="200" id="idProofVeteranCompleteButton" style="margin-top: 10px;" aria-label="Identify Veteran and ID Proof Complete">Identify Veteran and ID Proof Complete</button>
            <button tabindex="201" id="idProofCompleteButton" style="margin-top: 10px;" aria-label="ID Proof Complete">ID Proof Complete</button>
            <button tabindex="202" id="idProofFailedButton" style="margin-top: 10px;" aria-label="ID Proof Failed">ID Proof Failed</button>
        </fieldset>
    </div>

    <form id="birlsSearchForm">
        <div tabindex="60" class="search" id="birlsSearchDiv" style="width: 100%; float: left; display: none;">
            <table>
                <tbody>
                    <tr>
                        <td class="auto-style1">
                            <h2>Alternate Search: </h2>
                        </td>
                    </tr>
                </tbody>
            </table>
            <fieldset id="birlsFieldset">
                <legend>Search</legend>
                <hr style="border: 1px solid gray; border-image: none;">
                <table>
                    <tbody>
                        <tr>
                            <td class="auto-style1">
                                <label for="SocialSecurityBirlsTextBox">SSN</label>
                            </td>
                            <td>
                                <label for="FirstNameBirlsTextBox">First</label>
                            </td>
                            <td>
                                <label for="LastNameBirlsTextBox">Last</label>
                            </td>
                            <td>
                                <label for="DobBirlsTextBox">DOB</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="auto-style1">
                                <input name="ssn" tabindex="61" title="Social Security Number (9 char max)" class="formInputText" id="SocialSecurityBirlsTextBox" onfocus="clearField(this)" type="text" size="16" maxlength="50">
                            </td>
                            <td>
                                <input name="firstName" tabindex="62" title="First Name (30 char max)" class="formInputText" id="FirstNameBirlsTextBox" onfocus="clearField(this)" type="text" size="16" maxlength="30">
                            </td>
                            <td>
                                <input name="lastName" tabindex="63" title="Last Name (30 char max)" class="formInputText" id="LastNameBirlsTextBox" onfocus="clearField(this)" type="text" size="16" maxlength="30">
                            </td>
                            <td>

                                <input name="dateOfBirth" tabindex="64" title="Date of Birth in MM/DD/YYYY format" class="formInputText" id="DobBirlsTextBox" style="height: 30px;" onfocus="clearField(this)" type="text" size="10" maxlength="10" placeholder="MM/DD/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}">
                            </td>
                        </tr>
                        <tr>
                            <td class="auto-style1">
                                <label for="BranchOfServiceBirlsTextBox">Branch of Service</label>
                            </td>
                            <td>
                                <label for="ServiceNumberBirlsTextBox">Service Number</label>
                            </td>
                            <td>
                                <label for="InsuranceNumberBirlsTextBox">Insurance Number</label>
                            </td>
                            <td>
                                <label for="DateOfDeathBirlsTextBox">Date of Death</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="auto-style1">
                                <input name="branchOfService" tabindex="67" title="Branch of Service" class="formInputText" id="BranchOfServiceBirlsTextBox" onfocus="clearField(this)" type="text" size="16">
                            </td>
                            <td>
                                <input name="serviceNumber" tabindex="68" title="Service Number (30 char max)" class="formInputText" id="ServiceNumberBirlsTextBox" onfocus="clearField(this)" type="text" size="16" maxlength="30">
                            </td>
                            <td>
                                <input name="InsuranceNumber" tabindex="69" title="Insurance Number (30 char max)" class="formInputText" id="InsuranceNumberBirlsTextBox" onfocus="clearField(this)" type="text" size="16" maxlength="30">
                            </td>
                            <td>
                                <input name="dateOfDeath" tabindex="70" title="Date of Death in MM/DD/YYYY format" class="formInputText" id="DateOfDeathBirlsTextBox" style="height: 30px;" onfocus="clearField(this)" type="text" size="10" maxlength="10" placeholder="MM/DD/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="EnteredOnDutyBirlsTextBox">Entered on Duty</label>
                            </td>
                            <td>
                                <label for="ReleasedActiveDutyBirlsTextBox">Released Active Duty</label>
                            </td>
                            <td>
                                <label for="SuffixBirlsTextBox">Suffix</label>
                            </td>
                            <td>
                                <label for="PayeeNumberBirlsTextBox">Payee Number</label>
                            </td>
                            <td>
                                <label for="FolderLocationBirlsTextBox">Folder Location</label>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <input name="EnteredOnDuty" tabindex="71" title="Entered on Duty in MM/DD/YYYY format" class="formInputText" id="EnteredOnDutyBirlsTextBox" style="height: 30px;" onfocus="clearField(this)" type="text" size="10" maxlength="10" placeholder="MM/DD/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}">
                            </td>
                            <td>
                                <input name="ReleasedActiveDuty" tabindex="72" title="Released Active Duty in MM/DD/YYYY format" class="formInputText" id="ReleasedActiveDutyBirlsTextBox" style="height: 30px;" onfocus="clearField(this)" type="text" size="10" maxlength="10" placeholder="MM/DD/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}">
                            </td>
                            <td>
                                <input name="suffix" tabindex="73" title="Suffix (11 char max)" class="formInputText" id="SuffixBirlsTextBox" style="height: 30px;" onfocus="clearField(this)" type="text" size="2" maxlength="11">
                            </td>
                            <td>
                                <input name="payeeNumber" tabindex="74" title="Payee Number (2 digit max)" class="formInputText" id="PayeeNumberBirlsTextBox" style="height: 30px;" onfocus="clearField(this)" type="text" size="2" maxlength="2" pattern="[0-9]*">
                            </td>
                            <td>
                                <input name="folderLocation" tabindex="75" title="Folder Location (30 char max)" class="formInputText" id="FolderLocationBirlsTextBox" style="height: 30px;" onfocus="clearField(this)" type="text" size="16" maxlength="30">
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-top: 10px;" colspan="4">
                                <button tabindex="80" id="SearchBirlsButton" aria-label="Search BIRLS" type="submit">Search</button>
                                <button tabindex="81" id="ResetSearchBirlsButton" aria-label="Reset Search by BIRLS" type="reset">Reset Alternate Search</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>
        </div>
        <div tabindex="70" class="search" id="notFoundDiv" style="width: 100%; float: left; display: none;">
            <fieldset id="notFoundFieldset">
                <legend>No Records Found</legend>
                <!--<hr style="border: 1px solid gray;">-->
                <!--                <table>
                    <tbody>
                        <tr>
                            <td>
                                <button tabindex="82" title="Create New Veteran Using Alternate Search Criteria" id="createNewVeteranButton" aria-label="Create New Veteran Using Alternate Search Critera">Create New Veteran</button>
                            </td>
                        </tr>
                    </tbody>
                </table>-->
            </fieldset>
        </div>
    </form>
    <div class="search" id="tmpDialog">
        <img alt="Loading Image" src="udo_/images/search/loading.gif">
        <p>Working on it. Please wait...</p>
    </div>


</body>
</html>